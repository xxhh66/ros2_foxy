# 4.9 è¡¥å……é€šè®¯æœºåˆ¶ä¸Šæ•´ä½“è®¾è®¡

## 1. æ•´ä½“è®¾è®¡

> `li4 `:         è´Ÿè´£â€œç”Ÿäº§å†…å®¹ + æä¾›åŸºç¡€æœåŠ¡â€ï¼Œ
> ` wang2`      è´Ÿè´£â€œä¸­é—´å•†/ç¼“å­˜ + äºŒæ¬¡æœåŠ¡â€ï¼Œ
>  `zhang3`   æ˜¯æœ€ç»ˆâ€œæ¶ˆè´¹è€…/å®¢æˆ·ç«¯â€

| èŠ‚ç‚¹       | è¯­è¨€   | æ ¸å¿ƒè§’è‰²                     | é€šä¿¡æ–¹å¼                |
| ---------- | ------ | ---------------------------- | ----------------------- |
| **li4**    | Python | å†…å®¹ç”Ÿäº§è€… + æœåŠ¡ç«¯          | Topic + Service         |
| **wang2**  | C++    | ä¸­é—´å•† / ç¼“å­˜è€… / äºŒæ¬¡æœåŠ¡ç«¯ | Topic + Topic + Service |
| **zhang3** | C++    | çº¯æ¶ˆè´¹è€… / æœåŠ¡å®¢æˆ·ç«¯        | Service                 |

### ç¬¬1æ­¥ï¼Œåˆ›å»º`village_wang` `village_zhang` `village_li` `village_interfaces`åŒ…

```shell
mkdir charpter4/src && cd charpter4/src
# [1] åˆ›å»ºvillage_wang village_zhang village_li village_interfacesåŒ…
# wang2 zhang3 ä½¿ç”¨cppåˆ›å»º
ros2 pkg create village_wang --build-type ament_cmake --dependencies rclcpp
ros2 pkg create village_zhang --build-type ament_cmake --dependencies rclcpp
# li4ä½¿ç”¨pythonåˆ›å»º
ros2 pkg create village_li --build-type ament_python --dependencies rclpy
# åˆ›å»ºæ¥å£
ros2 pkg create village_interfaces --build-type ament_cmake 
```

```shell
ubuntu20@ubuntu:~/code/markdown/ros2_foxy/charpter4/src$ tree
.
â”œâ”€â”€ village_interfaces
â”‚Â Â  â”œâ”€â”€ CMakeLists.txt
â”‚Â Â  â”œâ”€â”€ include
â”‚Â Â  â”‚Â Â  â””â”€â”€ village_interfaces
â”‚Â Â  â”œâ”€â”€ package.xml
â”‚Â Â  â””â”€â”€ src
â”œâ”€â”€ village_li
â”‚Â Â  â”œâ”€â”€ package.xml
â”‚Â Â  â”œâ”€â”€ resource
â”‚Â Â  â”‚Â Â  â””â”€â”€ village_li
â”‚Â Â  â”œâ”€â”€ setup.cfg
â”‚Â Â  â”œâ”€â”€ setup.py
â”‚Â Â  â”œâ”€â”€ test
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ test_copyright.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ test_flake8.py
â”‚Â Â  â”‚Â Â  â””â”€â”€ test_pep257.py
â”‚Â Â  â””â”€â”€ village_li
â”‚Â Â      â””â”€â”€ __init__.py
â”œâ”€â”€ village_wang
â”‚Â Â  â”œâ”€â”€ CMakeLists.txt
â”‚Â Â  â”œâ”€â”€ include
â”‚Â Â  â”‚Â Â  â””â”€â”€ village_wang
â”‚Â Â  â”œâ”€â”€ package.xml
â”‚Â Â  â””â”€â”€ src
â””â”€â”€ village_zhang
    â”œâ”€â”€ CMakeLists.txt
    â”œâ”€â”€ include
    â”‚Â Â  â””â”€â”€ village_zhang
    â”œâ”€â”€ package.xml
    â””â”€â”€ src

16 directories, 14 files

```

### ç¬¬2æ­¥:è‡ªå®šä¹‰æ¥å£`village_interfaces`

```shell
# [2] åˆ›å»ºcpp py msgç­‰æ–‡ä»¶
# åˆ›å»ºæ¥å£
cd village_interfaces
mkdir msg && cd msg
touch Novel.msg

mkdir srv && cd srv
touch BorrowMoney.srv
touch SellNovel.srv
#  .
# â”œâ”€â”€ CMakeLists.txt
# â”œâ”€â”€ include
# â”‚Â Â  â””â”€â”€ village_interfaces
# â”œâ”€â”€ msg
# â”‚Â Â  â””â”€â”€ Novel.msg
# â”œâ”€â”€ package.xml
# â”œâ”€â”€ src
# â””â”€â”€ srv
#     â”œâ”€â”€ BorrowMoney.srv
#     â””â”€â”€ SellNovel.srv
```

![image-20260104153326460](assets/image-20260104153326460.png)

<font color=red>ä¿®æ”¹1ï¼šcmake</font>

```cmake
# ä¿®æ”¹cmake,find_package(ament_cmake REQUIRED)ä¸‹é¢æ·»åŠ 
#æŸ¥æ‰¾sensor_msgsåº“
find_package(sensor_msgs REQUIRED)
find_package(rosidl_default_generators REQUIRED)
#æ·»åŠ æ¶ˆæ¯æ–‡ä»¶å’Œä¾èµ–
rosidl_generate_interfaces(${PROJECT_NAME}
  #---msg---
  "msg/Novel.msg"
  #---srv---
  "srv/BorrowMoney.srv"
  "srv/SellNovel.srv"
   DEPENDENCIES sensor_msgs
 )
```

![image-20260104153434513](assets/image-20260104153434513.png)

<font color=red>ä¿®æ”¹2ï¼špackage.xml</font>

```xml
  <build_depend>sensor_msgs</build_depend>
  <build_depend>rosidl_default_generators</build_depend>
  <exec_depend>rosidl_default_runtime</exec_depend>
  <member_of_group>rosidl_interface_packages</member_of_group>
```

![image-20260104153711198](assets/image-20260104153711198.png)

<font color=red>ä¿®æ”¹3ï¼šNovel.msg</font>

```bash
# æ ‡å‡†æ¶ˆæ¯æ¥å£ å­—ç¬¦ä¸²
string content
# å›¾åƒæ¶ˆæ¯ï¼Œè°ƒç”¨sensor_msgsä¸‹çš„Imageç±»å‹
sensor_msgs/Image image
```

<font color=red>ä¿®æ”¹4ï¼šBorrowMoney.srv</font>

```bash
string name
uint32 money
---
bool success
uint32 money
```

<font color=red>ä¿®æ”¹5ï¼šSellNovel.srv</font>

```bash
uint32 money
---
string[] novels
```

<font color=red>`colcon` ç¼–è¯‘æµ‹è¯•</font>

```shell
colcon build --packages-select village_interfaces
```

![image-20260104154136181](assets/image-20260104154136181.png)

```shell
# éªŒè¯æµ‹è¯•
source install/setup.bash 
ros2 interface package village_interfaces  #æŸ¥çœ‹åŒ…ä¸‹æ‰€æœ‰æ¥å£
ros2 interface show village_interfaces/msg/Novel #æŸ¥çœ‹å†…å®¹
ros2 interface proto village_interfaces/msg/Novel #æ˜¾ç¤ºå±æ€§
```

![image-20260104154323782](assets/image-20260104154323782.png)

### ç¬¬3æ­¥ï¼šå®šä¹‰åŒ…`village_li`

![image-20260104161139527](assets/image-20260104161139527.png)

<font color=red>ä¿®æ”¹1ï¼šli4.py</font>

```shell
cd village_li
touch li3.py
touch li4.py
```

```python
# ç¼–å†™li4.pyï¼Œæ–‡ä»¶ç¼–ç å¿…utf-8
#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
# å¯¼å…¥è¯é¢˜æ¶ˆæ¯ç±»å‹
from std_msgs.msg import String,UInt32
# ä»æ‘åº„æ¥å£æœåŠ¡ç±»ä¸­å¯¼å…¥å€Ÿé’±æœåŠ¡
from village_interfaces.srv import BorrowMoney

class WriterNode(Node):
    """
    åˆ›å»ºä¸€ä¸ªæå››èŠ‚ç‚¹ï¼Œå¹¶åœ¨åˆå§‹åŒ–æ—¶è¾“å‡ºä¸€ä¸ªè¯
    """
    def __init__(self,name):
        super().__init__(name)
        self.get_logger().info("å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯%s,æˆ‘æ˜¯ä¸€åä½œå®¶ï¼" % name)
        # åˆ›å»ºå¹¶åˆå§‹åŒ–å‘å¸ƒè€…æˆå‘˜å±æ€§pubnovel
        self.pubnovel = self.create_publisher(String,"sexy_girl", 10) 


        # åˆ›å»ºå®šæ—¶å™¨æˆå‘˜å±æ€§timer
        self.i = 0 # i æ˜¯ä¸ªè®¡æ•°å™¨ï¼Œç”¨æ¥ç®—ç« èŠ‚ç¼–å·çš„
        timer_period = 5  #æ¯5så†™ä¸€ç« èŠ‚è¯
        self.timer = self.create_timer(timer_period, self.timer_callback)  #å¯åŠ¨ä¸€ä¸ªå®šæ—¶è£…ç½®ï¼Œæ¯ 1 s,è°ƒç”¨ä¸€æ¬¡time_callbackå‡½æ•°


        # è´¦æˆ·é’±çš„æ•°é‡
        self.account = 80
        # åˆ›å»ºå¹¶åˆå§‹åŒ–è®¢é˜…è€…æˆå‘˜å±æ€§submoney
        self.submoney = self.create_subscription(UInt32,"sexy_girl_money",self.recv_money_callback,10)
        
        # åˆ›å»ºå‘å¤–å€Ÿé’±æœåŠ¡
        self.borrow_server = self.create_service(BorrowMoney, "borrow_money", self.borrow_money_callback)

    def borrow_money_callback(self,request, response):
        """
        å€Ÿé’±å›è°ƒå‡½æ•°
        å‚æ•°ï¼šrequest å®¢æˆ·ç«¯è¯·æ±‚
             responseï¼š æœåŠ¡ç«¯å“åº”
        è¿”å›å€¼ï¼šresponse
        """
        #æ ¹æ®æå››å€Ÿé’±è§„åˆ™ï¼Œå€Ÿå‡ºå»çš„é’±ä¸èƒ½å¤šäºè‡ªå·±æ‰€æœ‰é’±çš„ååˆ†ä¹‹ä¸€ï¼Œä¸ç„¶å°±ä¸å€Ÿ
        self.get_logger().info("æ”¶åˆ°æ¥è‡ª: %s çš„å€Ÿé’±è¯·æ±‚ï¼Œç›®å‰è´¦æˆ·å†…è¿˜æœ‰%då…ƒ" % (request.name, self.account))
        if request.money <= int(self.account*0.1):
            response.success = True
            response.money = request.money
            self.account = self.account - request.money
            self.get_logger().info("å€Ÿé’±æˆåŠŸï¼Œå€Ÿå‡º%d å…ƒ ,ç›®å‰è´¦æˆ·ä½™é¢%d å…ƒ" % (response.money,self.account))
        else:
            response.success = False
            response.money = 0
            self.get_logger().info("å¯¹ä¸èµ·å…„å¼Ÿï¼Œæ‰‹å¤´ç´§,ä¸èƒ½å€Ÿç»™ä½ ")
        return response


    def timer_callback(self):
        """
        å®šæ—¶å™¨å›è°ƒå‡½æ•°
        """
        msg = String()
        msg.data = 'ç¬¬%då›ï¼šæ½‹æ»Ÿæ¹– %d æ¬¡å¶é‡èƒ¡è‰³å¨˜' % (self.i,self.i)
        self.pubnovel.publish(msg)  #å°†å°è¯´å†…å®¹å‘å¸ƒå‡ºå»
        self.get_logger().info('æå››:æˆ‘å‘å¸ƒäº†è‰³å¨˜ä¼ å¥‡ï¼š"%s"' % msg.data)    #æ‰“å°ä¸€ä¸‹å‘å¸ƒçš„æ•°æ®ï¼Œä¾›æˆ‘ä»¬çœ‹
        self.i += 1 #ç« èŠ‚ç¼–å·+1


    def recv_money_callback(self,money):
        """
        æ”¶é’±å›è°ƒå‡½æ•°
        """
        self.account += money.data
        self.get_logger().info('æå››ï¼šæˆ‘å·²ç»æ”¶åˆ°äº†%dçš„ç¨¿è´¹' % self.account)


def main(args=None):
    """
    ros2è¿è¡Œè¯¥èŠ‚ç‚¹çš„å…¥å£å‡½æ•°ï¼Œå¯é…ç½®å‡½æ•°åç§°
    """
    rclpy.init(args=args) # åˆå§‹åŒ–rclpy
    node = WriterNode("li4")  # æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹
    rclpy.spin(node) # ä¿æŒèŠ‚ç‚¹è¿è¡Œï¼Œæ£€æµ‹æ˜¯å¦æ”¶åˆ°é€€å‡ºæŒ‡ä»¤ï¼ˆCtrl+Cï¼‰
    rclpy.shutdown() # rclå…³é—­
```

```python
# li3.py
#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
from std_msgs.msg import String
from village_interfaces.srv import BorrowMoney

class BaiPiaoNode(Node):
    """
    åˆ›å»ºä¸€ä¸ªæä¸‰èŠ‚ç‚¹ï¼Œå¹¶åœ¨åˆå§‹åŒ–æ—¶è¾“å‡ºä¸€ä¸ªè¯
    """
    def __init__(self,name):
        super().__init__(name)
        self.get_logger().info("å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ç™½å«–å…š%sï¼Œæˆ‘å¯ä»¥ç™½å«–æå››çš„å°è¯´ï¼"% name)
        self.sub_ = self.create_subscription(String,"sexy_girl",self.recv_callback,10)
        #åˆ›å»ºä¸€ä¸ªæœåŠ¡å®¢æˆ·ç«¯
        self.borrow_money_client_ = self.create_client(BorrowMoney, "borrow_money")

    def recv_callback(self,novel):
        self.get_logger().info('æˆ‘å·²ç»æ”¶åˆ°äº†ï¼š%s' % novel.data)
        
    def borrow_money_eat(self):
        """
        å€Ÿé’±åƒéº»è¾£çƒ«å‡½æ•°
        """
        #æ‰“å°ä¸€å¥è¯
        self.get_logger().info("æ‰¾æå››å€Ÿé’±åƒéº»è¾£çƒ«å–½")
        #ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼Œæ¯1sæ£€æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœæœåŠ¡æ²¡æœ‰å¯åŠ¨ï¼Œåˆ™ä¸€ç›´å¾ªç¯
        while not self.borrow_money_client_.wait_for_service(1.0):
            self.get_logger().warn("æå››ä¸åœ¨çº¿ï¼Œæˆ‘å†ç­‰ç­‰")
        # æ„å»ºè¯·æ±‚å†…å®¹
        request = BorrowMoney.Request()
        #å°†å½“å‰èŠ‚ç‚¹åç§°ä½œä¸ºå€Ÿé’±è€…å§“å
        request.name = self.get_name()
        #å€Ÿé’±é‡‘é¢10å…ƒ
        request.money = 10
        #å‘é€å¼‚æ­¥å€Ÿé’±è¯·æ±‚ï¼Œå€Ÿé’±æˆåŠŸåå°±è°ƒç”¨borrow_respoonse_callback()å‡½æ•°
        self.borrow_money_client_.call_async(request).add_done_callback(self.borrow_respoonse_callback)

    def borrow_respoonse_callback(self,response):
        """
        å€Ÿé’±ç»“æœå›è°ƒ
        """
        # æ‰“å°ä¸€ä¸‹ä¿¡æ¯
        result = response.result()
        if result.success == True:
            self.get_logger().info("ç™½å«–æˆåŠŸï¼Œå€Ÿåˆ°%d,åƒéº»è¾£çƒ«å»äº†" % result.money)
        else:
            self.get_logger().info("ç™½å«–å¤±è´¥ï¼šå®³ï¼Œè¿å‡ å—é’±éƒ½ä¸å€Ÿï¼Œä¸–æ€ç‚å‡‰å‘€")

def main(args=None):
    """
    ros2è¿è¡Œè¯¥èŠ‚ç‚¹çš„å…¥å£å‡½æ•°ï¼Œå¯é…ç½®å‡½æ•°åç§°
    """
    rclpy.init(args=args) # åˆå§‹åŒ–rclpy
    node = BaiPiaoNode("li3")  # æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹
    node.borrow_money_eat() #å€Ÿé’±
    rclpy.spin(node) # ä¿æŒèŠ‚ç‚¹è¿è¡Œï¼Œæ£€æµ‹æ˜¯å¦æ”¶åˆ°é€€å‡ºæŒ‡ä»¤ï¼ˆCtrl+Cï¼‰
    rclpy.shutdown() # rclå…³é—­
```



<font color=red>ä¿®æ”¹2ï¼špackage.xml</font>

```xml
  <!-- æ·»åŠ æ¥å£ä¾èµ– -->
  <depend>village_interfaces</depend>

  <build_depend>rosidl_default_generators</build_depend>
  <exec_depend>rosidl_default_runtime</exec_depend>
  <member_of_group>rosidl_interface_packages</member_of_group>

```

![image-20260104161319483](assets/image-20260104161319483.png)

<font color=red>ä¿®æ”¹3ï¼šsetup.py</font>

```python
    entry_points={
        'console_scripts': [
            "li4_node = village_li.li4:main",
            "li3_node = village_li.li3:main"
        ],
    },
```

![image-20260104161403037](assets/image-20260104161403037.png)

<font color=red>ç¼–è¯‘æµ‹è¯•</font>

```shell
colcon build --packages-select village_li
source install/setup.bash 
ros2 run village_li li4_node 
```



![image-20260104161748419](assets/image-20260104161748419.png)

### ç¬¬4æ­¥: å®šä¹‰åŒ…`village_wang

<font color=red>ä¿®æ”¹1ï¼šwang2.cpp</font>

```shell
touch src/wang2.cpp
```

```cpp
#include "rclcpp/rclcpp.hpp"
#include "std_msgs/msg/string.hpp"
#include "std_msgs/msg/u_int32.hpp"
#include "village_interfaces/srv/sell_novel.hpp"
#include <queue>

using std::placeholders::_1;
using std::placeholders::_2;

/*
    åˆ›å»ºä¸€ä¸ªç±»èŠ‚ç‚¹ï¼Œåå­—å«åšSingleDogNode,ç»§æ‰¿è‡ªNode.
*/
class SingleDogNode : public rclcpp::Node
{

public:
    // æ„é€ å‡½æ•°,æœ‰ä¸€ä¸ªå‚æ•°ä¸ºèŠ‚ç‚¹åç§°
    SingleDogNode(std::string name) : Node(name)
    {
        // æ‰“å°ä¸€å¥è‡ªæˆ‘ä»‹ç»
        RCLCPP_INFO(this->get_logger(), "å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å•èº«ç‹—%s.", name.c_str());
        // åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…æ¥è®¢é˜…æå››å†™çš„å°è¯´ï¼Œé€šè¿‡åå­—sexy_girl
        sub_novel = this->create_subscription<std_msgs::msg::String>("sexy_girl", 10, std::bind(&SingleDogNode::topic_callback, this, _1));
        // åˆ›å»ºå‘å¸ƒè€…
        pub_money = this->create_publisher<std_msgs::msg::UInt32>("sexy_girl_money", 10);
        // å®ä¾‹åŒ–å›è°ƒç»„
        callback_group_service_ = this->create_callback_group(rclcpp::CallbackGroupType::MutuallyExclusive);
        // å®ä¾‹åŒ–å–äºŒæ‰‹ä¹¦çš„æœåŠ¡
        server_sell = this->create_service<village_interfaces::srv::SellNovel>("sell_novel",
                                                                               std::bind(&SingleDogNode::sell_book_callback, this, _1, _2),
                                                                               rmw_qos_profile_services_default,
                                                                               callback_group_service_);
    }

private:
    // å£°æ˜ä¸€ä¸ªæœåŠ¡å›è°ƒç»„
    rclcpp::CallbackGroup::SharedPtr callback_group_service_;

    // å£°æ˜ä¸€ä¸ªè®¢é˜…è€…ï¼ˆæˆå‘˜å˜é‡ï¼‰,ç”¨äºè®¢é˜…å°è¯´
    rclcpp::Subscription<std_msgs::msg::String>::SharedPtr sub_novel;

    // å£°æ˜ä¸€ä¸ªå‘å¸ƒè€…ï¼ˆæˆå‘˜å˜é‡ï¼‰,ç”¨äºç»™æå››é’±
    rclcpp::Publisher<std_msgs::msg::UInt32>::SharedPtr pub_money;

    // åˆ›å»ºä¸€ä¸ªå°è¯´ç« èŠ‚é˜Ÿåˆ—
    std::queue<std_msgs::msg::String::SharedPtr> novels_queue;

    // å°è¯´ç« èŠ‚å•ä»·
    int novel_price = 1;

    // å£°æ˜ä¸€ä¸ªæœåŠ¡ç«¯
    rclcpp::Service<village_interfaces::srv::SellNovel>::SharedPtr server_sell;

    // æ”¶åˆ°è¯é¢˜æ•°æ®çš„å›è°ƒå‡½æ•°
    void topic_callback(const std_msgs::msg::String::SharedPtr msg)
    {
        // æ–°å»ºä¸€å¼ äººæ°‘å¸
        std_msgs::msg::UInt32 money;
        money.data = 10;

        // å‘é€äººæ°‘å¸ç»™æå››
        pub_money->publish(money);
        RCLCPP_INFO(this->get_logger(), "æœ•å·²é˜…ï¼š'%s'ï¼Œæ‰“èµæå››ï¼š%d å…ƒçš„ç¨¿è´¹", msg->data.c_str(), money.data);

        // å°†å°è¯´æ”¾å…¥novels_queueä¸­
        novels_queue.push(msg);
    };

    // å£°æ˜ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“æ”¶åˆ°ä¹°ä¹¦è¯·æ±‚æ—¶è°ƒç”¨è¯¥å‡½æ•°ï¼Œç”¨äºå¤„ç†æ•°æ®
    void sell_book_callback(const village_interfaces::srv::SellNovel::Request::SharedPtr request,
                            const village_interfaces::srv::SellNovel::Response::SharedPtr response)
    {
        RCLCPP_INFO(this->get_logger(), "æ”¶åˆ°ä¸€ä¸ªä¹°ä¹¦è¯·æ±‚ï¼Œä¸€å…±ç»™äº†%dé’±", request->money);
        unsigned int novelsNum = int(request->money / novel_price); // åº”ç»™å°è¯´æ•°é‡

        // åˆ¤æ–­å½“å‰ä¹¦åº“é‡Œä¹¦çš„æ•°é‡æ˜¯å¦æ»¡è¶³å¼ ä¸‰è¦ä¹°çš„æ•°é‡ï¼Œä¸å¤Ÿåˆ™è¿›å…¥ç­‰å¾…å‡½æ•°
        if (novels_queue.size() < novelsNum)
        {
            RCLCPP_INFO(this->get_logger(), "å½“å‰è‰³å¨˜ä¼ å¥‡ç« èŠ‚å­˜é‡ä¸º%dï¼šä¸èƒ½æ»¡è¶³éœ€æ±‚,å¼€å§‹ç­‰å¾…", novels_queue.size());

            // è®¾ç½®rateå‘¨æœŸä¸º1sï¼Œä»£è¡¨1sæ£€æŸ¥ä¸€æ¬¡
            rclcpp::Rate loop_rate(1);

            // å½“ä¹¦åº“é‡Œå°è¯´æ•°é‡å°äºè¯·æ±‚æ•°é‡æ—¶ä¸€ç›´å¾ªç¯
            while (novels_queue.size() < novelsNum)
            {
                // åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦è¿˜åœ¨è¿è¡Œ
                if (!rclcpp::ok())
                {
                    RCLCPP_ERROR(this->get_logger(), "ç¨‹åºè¢«ç»ˆæ­¢äº†");
                    return;
                }
                // æ‰“å°ä¸€ä¸‹å½“å‰çš„ç« èŠ‚æ•°é‡å’Œç¼ºå°‘çš„æ•°é‡
                RCLCPP_INFO(this->get_logger(), "ç­‰å¾…ä¸­ï¼Œç›®å‰å·²æœ‰%dç« ï¼Œè¿˜å·®%dç« ", novels_queue.size(), novelsNum - novels_queue.size());

                // rate.sleep()è®©æ•´ä¸ªå¾ªç¯1sè¿è¡Œä¸€æ¬¡
                loop_rate.sleep();
            }
        }
        // ç« èŠ‚æ•°é‡æ»¡è¶³éœ€æ±‚äº†
        RCLCPP_INFO(this->get_logger(), "å½“å‰è‰³å¨˜ä¼ å¥‡ç« èŠ‚å­˜é‡ä¸º%dï¼šå·²ç»æ»¡è¶³éœ€æ±‚", novels_queue.size());

        // ä¸€æœ¬æœ¬æŠŠä¹¦å–å‡ºæ¥ï¼Œæ”¾è¿›è¯·æ±‚å“åº”å¯¹è±¡responseä¸­
        for (unsigned int i = 0; i < novelsNum; i++)
        {
            response->novels.push_back(novels_queue.front()->data);
            novels_queue.pop();
        }
    }
};

int main(int argc, char **argv)
{
    rclcpp::init(argc, argv);
    /*äº§ç”Ÿä¸€ä¸ªWang2çš„èŠ‚ç‚¹*/
    auto node = std::make_shared<SingleDogNode>("wang2");
    /* è¿è¡ŒèŠ‚ç‚¹ï¼Œå¹¶æ£€æµ‹é€€å‡ºä¿¡å·*/
    rclcpp::executors::MultiThreadedExecutor exector;
    exector.add_node(node);
    exector.spin();
    rclcpp::shutdown();
    return 0;
}
```



<font color=red>ä¿®æ”¹2ï¼špackage.xml</font>

```xml
  <depend>rclcpp</depend>
  <depend>village_interfaces</depend>
```

![image-20260104163151491](assets/image-20260104163151491.png)

<font color=red>ä¿®æ”¹3ï¼šCMakeLists.txt</font>

```cmake
find_package(village_interfaces REQUIRED)


add_executable(wang2_node src/wang2.cpp)
ament_target_dependencies(wang2_node 
  rclcpp 
  village_interfaces)

install(TARGETS
  wang2_node
  DESTINATION lib/${PROJECT_NAME}
)
```

![image-20260104163232625](assets/image-20260104163232625.png)

<font color=red>éªŒè¯æµ‹è¯•</font>

```bash
colcon build --packages-select village_wang
source install/setup.bash
ros2 run village_wang wang2_node 
```

![image-20260104162706266](assets/image-20260104162706266.png)

### ç¬¬5æ­¥: å®šä¹‰åŒ…`village_zhang`

<font color=red>ä¿®æ”¹1ï¼šzhang3.cpp</font>

```shell
touch src/zhang3.cpp
```

```cpp
#include "rclcpp/rclcpp.hpp"
#include "village_interfaces/srv/sell_novel.hpp"

using std::placeholders::_1;
using std::placeholders::_2;

/*
    åˆ›å»ºä¸€ä¸ªç±»èŠ‚ç‚¹ï¼Œåå­—å«åšPoorManNode,ç»§æ‰¿è‡ªNode.
*/
class PoorManNode : public rclcpp::Node
{

public:
    PoorManNode(std::string name) : Node(name)
    {
        // æ‰“å°ä¸€å¥è‡ªæˆ‘ä»‹ç»
        RCLCPP_INFO(this->get_logger(), "å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¾—äº†ç©·é¬¼%s.",name);
        //å®ä¾‹åŒ–æœåŠ¡å®¢æˆ·ç«¯
        client_ = this->create_client<village_interfaces::srv::SellNovel>("sell_novel");
    }

    void buy_novel()
    {
        RCLCPP_INFO(this->get_logger(), "ä¹°å°è¯´å»å–½");
        //ç­‰å¾…æœåŠ¡ç«¯ä¸Šçº¿
        while (!client_->wait_for_service(std::chrono::seconds(1)))
        {
            //ç­‰å¾…æ—¶æ£€æµ‹rclcppçš„çŠ¶æ€
            if (!rclcpp::ok())
            {
                RCLCPP_ERROR(this->get_logger(), "ç­‰å¾…æœåŠ¡çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­...");
                return;
            }
            RCLCPP_INFO(this->get_logger(), "ç­‰å¾…æœåŠ¡ç«¯ä¸Šçº¿ä¸­");
        }
        //æ„é€ è¯·æ±‚çš„é’±
        auto request = std::make_shared<village_interfaces::srv::SellNovel_Request>();
        //å…ˆæ¥äº”å—é’±çš„çœ‹çœ‹å¥½ä¸å¥½çœ‹
        request->money = 5; 
        //å‘é€å¼‚æ­¥è¯·æ±‚ï¼Œç„¶åç­‰å¾…è¿”å›ï¼Œè¿”å›æ—¶è°ƒç”¨å›è°ƒå‡½æ•°
        client_->async_send_request(request,std::bind(&PoorManNode::novels_callback, this, _1));
    };
    
private:
    // åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯
    rclcpp::Client<village_interfaces::srv::SellNovel>::SharedPtr client_;

    //åˆ›å»ºæ¥æ”¶åˆ°å°è¯´çš„å›è°ƒå‡½æ•°
    void novels_callback(rclcpp::Client<village_interfaces::srv::SellNovel>::SharedFuture  response)
    {
        auto result = response.get();
        RCLCPP_INFO(this->get_logger(), "æ”¶åˆ°%dç« çš„å°è¯´ï¼Œç°åœ¨å¼€å§‹æŒ‰ç« èŠ‚å¼€è¯»", result->novels.size());
        for(std::string novel:result->novels)
        {
            //æ‰“å°å°è¯´ç« èŠ‚å†…å®¹
            RCLCPP_INFO(this->get_logger(), "%s", novel.c_str());
        }
        RCLCPP_INFO(this->get_logger(), "å°è¯´è¯»å®Œäº†ï¼Œå¥½åˆºæ¿€ï¼Œå†™çš„çœŸä¸é”™ï¼Œå¥½æœŸå¾…ä¸‹é¢çš„ç« èŠ‚å‘€ï¼");
    }

};

int main(int argc, char **argv)
{
    rclcpp::init(argc, argv);
    /*äº§ç”Ÿä¸€ä¸ªPoorManNodeçš„èŠ‚ç‚¹*/
    auto node = std::make_shared<PoorManNode>("zhang3");
    node->buy_novel();
    /* è¿è¡ŒèŠ‚ç‚¹ï¼Œå¹¶æ£€æµ‹rclcppçŠ¶æ€*/
    rclcpp::spin(node);
    rclcpp::shutdown();
    return 0;
}
```



<font color=red>ä¿®æ”¹2ï¼špackage.xml</font>

```xml
  <depend>rclcpp</depend>
  <depend>village_interfaces</depend>
```

![image-20260104163151491](assets/image-20260104163151491.png)

<font color=red>ä¿®æ”¹3ï¼šCMakeLists.txt</font>

```cmake
find_package(village_interfaces REQUIRED)


add_executable(zhang3_node src/zhang3.cpp)
ament_target_dependencies(zhang3_node
  rclcpp 
  village_interfaces)

install(TARGETS
  zhang3_node
  DESTINATION lib/${PROJECT_NAME}
)
```

![image-20260104163130187](assets/image-20260104163130187.png)

<font color=red>éªŒè¯æµ‹è¯•</font>

```bash
colcon build --packages-select village_zhang
source install/setup.bash
ros2 run village_zhang zhang3_node 
```

![image-20260104163634628](assets/image-20260104163634628.png)

## 2. ç»“æ„åˆ†æ

### 2.1. `li4ï¼ˆWriterNodeï¼‰`â€”â€”å†…å®¹æºå¤´ + å€Ÿé’±æœåŠ¡

+ <font color=red>`li4` åšäº†ä»€ä¹ˆï¼Ÿ</font>

ï¼ˆ1ï¼‰å‘å¸ƒå°è¯´ï¼ˆTopic Publisher å‘å¸ƒï¼‰

> `ROS2`ä¸­`Topic`é€šä¿¡æ–¹å¼ï¼Œ`Topic`é€šä¿¡æ¨¡å‹æ˜¯ä¸€ç§å‘å¸ƒè®¢é˜…æ¨¡å‹ã€‚

```python
self.pubnovel = self.create_publisher(String,"sexy_girl", 10)
```

- **è¯é¢˜å**ï¼š`sexy_girl`
- **ç±»å‹**ï¼š`std_msgs/String`
- **ä½œç”¨**ï¼šå®šæ—¶å‘å¸ƒå°è¯´ç« èŠ‚å†…å®¹

```python
# åˆ›å»ºå®šæ—¶å™¨å›è°ƒå‡½æ•°ï¼Œå®šæ—¶å‘å¸ƒå°è¯´
msg.data = 'ç¬¬%då›ï¼šæ½‹æ»Ÿæ¹– %d æ¬¡å¶é‡èƒ¡è‰³å¨˜'
self.pubnovel.publish(msg)
```

> `li4` æ˜¯ **å°è¯´å”¯ä¸€ç”Ÿäº§è€…**

ï¼ˆ2ï¼‰æ”¶ç¨¿è´¹ï¼ˆTopic Subscriberè®¢é˜…ï¼‰

```python
self.submoney = self.create_subscription(
    UInt32,"sexy_girl_money",self.recv_money_callback,10)
```

- æ¥æ”¶æ¥è‡ª **wang2** æ‰“èµçš„é’±
- ä¿®æ”¹è‡ªå·±çš„ `account`

ï¼ˆ3ï¼‰æä¾›â€œå€Ÿé’±â€æœåŠ¡ï¼ˆService Serverï¼‰

```python
self.borrow_server = self.create_service(
    BorrowMoney, "borrow_money", self.borrow_money_callback)
```

- **æœåŠ¡å**ï¼š`borrow_money`
- **è§’è‰²**ï¼šæœåŠ¡ç«¯
- **è§„åˆ™**ï¼šæœ€å¤šå€Ÿè‡ªå·±èµ„äº§çš„ 10%

**æ³¨æ„**ï¼š
 chapter4 ä¸­ **zhang3 å¹¶æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªæœåŠ¡**ï¼Œè¿™æ˜¯ç•™ç»™å‰åç« èŠ‚æˆ–å¯¹æ¯”å­¦ä¹ ç”¨çš„ã€‚

+ <font color=red> li4 çš„ç»“æ„æ€»ç»“</font>

```shell
li4 (WriterNode)
 â”œâ”€â”€ Publisher: sexy_girl (String)   â† å°è¯´æºå¤´
 â”œâ”€â”€ Subscriber: sexy_girl_money     â† æ”¶ç¨¿è´¹
 â””â”€â”€ Service Server: borrow_money
```

### 2.2.`wang2ï¼ˆSingleDogNodeï¼‰`â€”â€”ä¸­é—´å•† / å°è¯´ç¼“å­˜è€…

è¿™æ˜¯ **chapter4 é‡Œæœ€æ ¸å¿ƒã€æœ€â€œå·¥ç¨‹åŒ–â€çš„èŠ‚ç‚¹**ã€‚

+ wang2 çš„ä¸‰é‡èº«ä»½

<font color=red>èº«ä»½ä¸€ï¼šå°è¯´è¯»è€…ï¼ˆSubscriberï¼‰</font>

```c++
sub_novel = this->create_subscription<std_msgs::msg::String>(
    "sexy_girl", 10, ...
);
```

- è®¢é˜… **li4 å‘å¸ƒçš„å°è¯´**
- æ¯æ¥ä¸€ç« ï¼Œå°±ç¼“å­˜èµ·æ¥

```c++
novels_queue.push(msg);
```

â¡ **wang2 æŠŠå°è¯´å­˜è¿›é˜Ÿåˆ—**

<font color=red>èº«ä»½äºŒï¼šç¨¿è´¹æ”¯ä»˜è€…ï¼ˆPublisherï¼‰</font>

```c++
pub_money = this->create_publisher<std_msgs::msg::UInt32>(
    "sexy_girl_money", 10);
```

- æ¯æ”¶åˆ°ä¸€ç« å°è¯´
- ç»™ li4 æ‰“èµ 10 å…ƒ

```c++
money.data = 10;
pub_money->publish(money);
```

â¡ **å½¢æˆâ€œçœ‹å°è¯´ â†’ ä»˜é’±â€çš„é—­ç¯**

<font color=red>èº«ä»½ä¸‰ï¼šå–å°è¯´çš„äºŒé“è´©å­ï¼ˆService Serverï¼‰</font>

```c++
server_sell = this->create_service<village_interfaces::srv::SellNovel>(
    "sell_novel", ...
);
```

- **æœåŠ¡å**ï¼š`sell_novel`

- **æœåŠ¡å†…å®¹**ï¼š

  > å¼ ä¸‰ç»™é’± â†’ ç‹äºŒæŒ‰é’±æ•°ç»™å°è¯´ç« èŠ‚

<font color=red>å…³é”®è®¾è®¡ç‚¹ï¼ˆéå¸¸é‡è¦ï¼‰</font>

```c++
std::queue<std_msgs::msg::String::SharedPtr> novels_queue;
```

- wang2 **ä¸ç›´æ¥ç”Ÿäº§å†…å®¹**
- å®ƒåªå–ã€Œå·²ç»ç¼“å­˜çš„ç« èŠ‚ã€

<font color=red>ç­‰å¾…æœºåˆ¶ï¼ˆchapter4 çš„é‡ç‚¹ï¼‰</font>

```c++
while (novels_queue.size() < novelsNum)
{
    loop_rate.sleep();
}
```

â¡ å¦‚æœåº“å­˜ä¸å¤Ÿï¼š

- **é˜»å¡ç­‰å¾…**
- ä¸€è¾¹ç­‰ä¸€è¾¹ç»§ç»­æ¥æ”¶ li4 çš„æ–°ç« èŠ‚

ğŸ“Œ **è¿™æ˜¯ ROS2 æœåŠ¡é‡Œä¸€ä¸ªéå¸¸ç»å…¸çš„â€œåŒæ­¥ç­‰å¾…èµ„æºâ€ç¤ºä¾‹**

<font color=red> wang2 çš„ç»“æ„æ€»ç»“</font>

```
wang2 (SingleDogNode)
 â”œâ”€â”€ Subscriber: sexy_girl           â† ä» li4 æ”¶å°è¯´
 â”œâ”€â”€ Publisher: sexy_girl_money      â†’ ç»™ li4 æ‰“é’±
 â”œâ”€â”€ Queue: novels_queue             â† å°è¯´ç¼“å­˜
 â””â”€â”€ Service Server: sell_novel      â† å–å°è¯´ç»™ zhang3
```

### 2.3. `zhang3ï¼ˆPoorManNodeï¼‰`â€”â€”æœ€ç»ˆæ¶ˆè´¹è€…

> `zhang3 `çš„åŠŸèƒ½éå¸¸å•ä¸€ï¼ˆä½†å¾ˆé‡è¦ï¼‰

```c++
client_ = this->create_client<village_interfaces::srv::SellNovel>(
    "sell_novel");
```

- **åªåšä¸€ä»¶äº‹**ï¼šä¹°å°è¯´

è´­ä¹°æµç¨‹

```c++

request->money = 5;
client_->async_send_request(...)
```

- ç»™ 5 å—é’±
- ç­‰ wang2 è¿”å›ç« èŠ‚

å›è°ƒä¸­æ¶ˆè´¹å°è¯´

```c++

for(std::string novel: result->novels)
{
    RCLCPP_INFO(this->get_logger(), "%s", novel.c_str());
}
```

â¡ **zhang3 å®Œå…¨ä¸å…³å¿ƒå°è¯´æ¥æº**
 â¡ å®ƒåªè®¤æœåŠ¡æ¥å£

zhang3 çš„ç»“æ„æ€»ç»“

```

zhang3 (PoorManNode)
 â””â”€â”€ Service Client: sell_novel  â† å‘ wang2 ä¹°å°è¯´
```

### 2.4 ä¸‰è€…ä¹‹é—´çš„å®Œæ•´é€šä¿¡å…³ç³»å›¾ï¼ˆé‡ç‚¹ï¼‰

```

                 Topic: sexy_girl
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚
     li4 (ä½œè€…)                        wang2 (äºŒé“è´©å­)
        â”‚                                 â”‚
        â”‚      Topic: sexy_girl_money     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚ Service: sell_novel
                                          â–¼
                                     zhang3 (ç©·è¯»è€…)
```

------