# [4.5.1 è‡ªå®šä¹‰æœåŠ¡æ¥å£](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_451-è‡ªå®šä¹‰æœåŠ¡æ¥å£)

å¸…é±¼åˆæ¥äº†ï¼Œä¸Šä¸€èŠ‚å°é±¼ç»™å¤§å®¶ä»‹ç»äº†ä»€ä¹ˆæ˜¯æœåŠ¡ï¼Œå¹¶ä¸”ç»™å¤§å®¶ä¸¾äº†æä¸‰å‘æå››å€Ÿé’±åƒéº»è¾£çƒ«ï¼Œå¼ ä¸‰å‘ç‹äºŒä¹°äºŒæ‰‹ä¹¦çš„ä¾‹å­ã€‚ä½œä¸ºROSé•‡çš„åˆ›é€ è€…çš„æˆ‘ä»¬ï¼Œè‚¯å®šè¦æ»¡è¶³æ‘æ°‘ä»¬çš„éœ€æ±‚ã€‚

æ‰€ä»¥æœ¬èŠ‚å°é±¼å°†å¸¦ä½ ä¸€èµ·ï¼Œåˆ›é€ ä¸€ä¸ªå€Ÿé’±æœåŠ¡æ¥å£å’Œä¸€ä¸ªä¹°ä¹¦æœåŠ¡æ¥å£ã€‚

## [1.æœåŠ¡æ¥å£ä»‹ç»](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_1æœåŠ¡æ¥å£ä»‹ç»)

åœ¨4.5åˆ°4.6ç« èŠ‚ä¸­ï¼Œå°é±¼ä»‹ç»äº†æ¥å£å’Œè¯é¢˜æ¥å£çš„æ¦‚å¿µã€‚é‚£æœåŠ¡æ¥å£å’Œè¯é¢˜æ¥å£æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ

é‚£å°±è¦çœ‹ï¼Œè¯é¢˜å’ŒæœåŠ¡æœ‰ä»€ä¹ˆä¸åŒä¹‹å¤„äº†ã€‚ä¹‹å‰å°é±¼æ›¾æèµ·è¿‡ï¼š

- è¯é¢˜æ˜¯**å‘å¸ƒè®¢é˜…æ¨¡å‹**ã€‚ä¸»è¦æ˜¯å•å‘ä¼ è¾“æ•°æ®ï¼Œåªèƒ½ç”±å‘å¸ƒè€…å‘å¸ƒï¼Œæ¥æ”¶è€…æ¥æ”¶ï¼ˆåŒä¸€è¯é¢˜ï¼Œå‘å¸ƒè€…æ¥æ”¶è€…éƒ½å¯ä»¥æœ‰å¤šä¸ªï¼‰
- æœåŠ¡æ˜¯**å®¢æˆ·ç«¯æœåŠ¡ç«¯ï¼ˆè¯·æ±‚å“åº”ï¼‰æ¨¡å‹**ã€‚ç”±å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å¤„ç†è¯·æ±‚ï¼Œç„¶åè¿”å›å¤„ç†ç»“æœï¼ˆåŒä¸€æœåŠ¡ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç”±å¤šä¸ªï¼ŒæœåŠ¡ç«¯åªèƒ½æœ‰ä¸€ä¸ªï¼‰

ç”±ä»¥ä¸Šå·®åˆ«æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œè¯é¢˜é€šä¿¡æ˜¯å•å‘çš„ï¼Œè‡ªå®šä¹‰è¯é¢˜åªéœ€è¦å®šä¹‰**ä¼ è¿‡å»çš„æ•°æ®ç±»å‹**å°±è¡Œï¼Œè€ŒæœåŠ¡æ˜¯åŒå‘çš„ï¼Œæ‰€ä»¥è¦å®šä¹‰**ä¸€å»ä¸€å›ä¸¤ç§æ•°æ®ç±»å‹**ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœåŠ¡çš„æ¶ˆæ¯æ¥å£é•¿ä»€ä¹ˆæ ·å­ï¼Ÿ

æœåŠ¡æ¥å£æ ¼å¼ï¼š`xxx.srv`

```bash
int64 a
int64 b
---
int64 sum
```

ä¸è¯é¢˜ä¸åŒçš„æ˜¯ï¼Œsrvæ–‡ä»¶æ¯”msgæ–‡ä»¶ä¸­é—´å¤šå‡ºäº†ä¸‰ä¸ª`---`è¿™ä¸‰ä¸ªæ æ å°±æ˜¯åˆ†ç•Œçº¿ï¼Œä¸Šæ–¹çš„æ˜¯å®¢æˆ·ç«¯å‘é€è¯·æ±‚çš„æ•°æ®ç»“æ„å®šä¹‰ï¼Œä¸‹æ–¹çš„æ˜¯æœåŠ¡ç«¯å“åº”ç»“æœçš„æ•°æ®ç»“æ„å®šä¹‰ã€‚

æ˜¯ä¸æ˜¯ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œé‚£å¦‚ä½•åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„æœåŠ¡æ¥å£å‘¢ï¼Ÿå¯ä»¥å‚è€ƒä¸‹é¢çš„æ­¥éª¤ï¼š

- æ–°å»º`srv`æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨æ–‡ä»¶å¤¹ä¸‹æ–°å»º`xxx.srv`
- åœ¨`xxx.srv`ä¸‹ç¼–å†™æœåŠ¡æ¥å£å†…å®¹å¹¶ä¿å­˜
- åœ¨`CmakeLists.txt`æ·»åŠ ä¾èµ–å’Œsrvæ–‡ä»¶ç›®å½•
- åœ¨`package.xml`ä¸­æ·»åŠ `xxx.srv`æ‰€éœ€çš„ä¾èµ–
- ç¼–è¯‘åŠŸèƒ½åŒ…å³å¯ç”Ÿæˆ`python`ä¸c++å¤´æ–‡ä»¶

å½“ç„¶åœ¨åšä¸Šé¢çš„æ­¥éª¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åšä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…ã€‚å°±æ˜¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œç¡®å®šå¥½è¯·æ±‚çš„æ•°æ®ç»“æ„å’Œè¿”å›çš„æ•°æ®ç»“æ„ã€‚

## [2.åˆ›å»ºå€Ÿé’±æœåŠ¡æ¥å£](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_2åˆ›å»ºå€Ÿé’±æœåŠ¡æ¥å£)

æˆ‘ä»¬ä¾ç„¶æ˜¯åœ¨`village_interfaces`ä¸‹åˆ›å»ºæœåŠ¡æ¥å£ã€‚

### [2.1 ç¡®è®¤æ•°æ®ç»“æ„](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_21-ç¡®è®¤æ•°æ®ç»“æ„)

å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ ¹æ®æå››çš„éœ€æ±‚æ¥ç¡®å®šæ•°æ®ç»“æ„ã€‚

ä¸Šä¸€èŠ‚ä¸­æå››å¯¹å€Ÿé’±çš„è¦æ±‚å¦‚ä¸‹ï¼š

1. å€Ÿé’±ä¸€å®šè¦æ‰“æ¬ æ¡ï¼Œæ”¶åˆ°æ¬ æ¡æ‰èƒ½ç»™é’±
2. æ¯æ¬¡å€Ÿé’±ä¸èƒ½è¶…è¿‡è‡ªå·±å…¨éƒ¨èµ„é‡‘çš„`10%`ä¸”ä¸€å®šæ˜¯æ•´æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æå››å‡å¦‚ç°åœ¨æœ‰100å—é’±ï¼Œé‚£ä¹ˆæœ€å¤šå€Ÿå‡ºå»`100x10%=10`å—é’±

æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼Œæä¸‰å‘é€å€Ÿé’±è¯·æ±‚çš„æ—¶å€™ä¸€å®šè¦æœ‰æ¬ æ¡ï¼Œæˆ‘ä»¬æƒ³ä¸€ä¸‹ï¼Œæ¬ æ¡ä¸­åº”è¯¥è‡³å°‘åŒ…å«ä¸¤æ¡ä¿¡æ¯

- å€Ÿé’±è€…åå­—ï¼Œå­—ç¬¦ä¸²ç±»å‹ã€å¯ä»¥ç”¨`string`è¡¨ç¤º
- é‡‘é¢ï¼Œæ•´å½¢ï¼Œå¯ä»¥ç”¨`uint32`è¡¨ç¤º

é‚£è¯·æ±‚çš„æ•°æ®ç»“æ„æˆ‘ä»¬å°±å¯ä»¥ç¡®å®šä¸‹æ¥äº†ï¼Œæ¥ç€ç¡®å®šè¿”å›çš„æ•°æ®çš„æ ¼å¼ã€‚

æ—¢ç„¶æ˜¯å€Ÿé’±ï¼Œé‚£æå››å°±æœ‰å¯èƒ½æ‹’ç»ï¼Œä¼šæœ‰å€Ÿé’±å¤±è´¥çš„æƒ…å†µï¼Œæ‰€ä»¥è¿”å›æ•°æ®åº”è¯¥æœ‰è¿™ä¸¤æ¡ä¿¡æ¯ï¼š

- æ˜¯å¦å‡ºå€Ÿï¼šåªæœ‰æˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å†µï¼Œå¸ƒå°”ç±»å‹ï¼ˆ`bool`ï¼‰å¯è¡¨ç¤º
- å‡ºå€Ÿé‡‘é¢ï¼šæ— ç¬¦å·æ•´å½¢ï¼Œå¯ä»¥ç”¨`uint32`è¡¨ç¤ºï¼Œå€Ÿé’±å¤±è´¥æ—¶ä¸º0

### [2.2 åˆ›å»º`srv`æ–‡ä»¶å¤¹åŠ`BorrowMoney.srv`æ¶ˆæ¯æ–‡ä»¶](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_22-åˆ›å»ºsrvæ–‡ä»¶å¤¹åŠborrowmoneysrvæ¶ˆæ¯æ–‡ä»¶)

æ‰“å¼€VsCodeï¼Œç„¶åæ‰“å¼€`town_ws`ï¼Œåœ¨`village_interfaces`ä¸‹æ–°å»ºsrvæ–‡ä»¶å¤¹ã€‚

> åŒæ ·å¤§å®¶å¯ä»¥ä½¿ç”¨é¼ æ ‡å³å‡»æ–°å»ºï¼Œä¸ç”¨è¾“å…¥å‘½ä»¤è¡ŒğŸ˜œ

```shell
cd src/village_interfaces
mkdir srv && cd srv
touch BorrowMoney.srv
```

åˆ›å»ºå®Œæˆåçš„ç›®å½•ç»“æ„

![image-20210811162010736](assets/image-20210811162010736.png)

### [2.3 ç¼–å†™æ–‡ä»¶å†…å®¹](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_23-ç¼–å†™æ–‡ä»¶å†…å®¹)

æ—¢ç„¶ç¡®å®šäº†å†…å®¹ï¼Œç¼–å†™æ–‡ä»¶å°±å¾ˆç®€å•äº†

```bash
string name
uint32 money
---
bool success
uint32 money
```

### [2.4ä¿®æ”¹`CMakeLists.txt`](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_24ä¿®æ”¹cmakeliststxt)

å› ä¸ºåœ¨4.6ä¸­æˆ‘ä»¬å·²ç»æ·»åŠ è¿‡ä¾èµ–`DEPENDENCIES`å’Œ`msg`æ–‡ä»¶äº†ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç›´æ¥æ·»åŠ ä¸€ä¸ª`srv`å³å¯ã€‚

```cmake
find_package(rosidl_default_generators REQUIRED)
rosidl_generate_interfaces(${PROJECT_NAME}
  #---msg---
  "msg/Novel.msg"
  #---srv---
  "srv/BorrowMoney.srv"
  DEPENDENCIES sensor_msgs
 )
```

éœ€è¦å…³æ³¨çš„æ˜¯è¿™ä¸€è¡Œ`"srv/BorrowMoney.srv"`,æ·»åŠ äº†å¯¹åº”çš„æ–‡ä»¶ä½ç½®ã€‚

### [2.5ä¿®æ”¹`package.xml`](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_25ä¿®æ”¹packagexml)

åœ¨4.6èŠ‚æˆ‘ä»¬å·²ç»æ·»åŠ è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸ç”¨æ·»åŠ äº†ï¼Œå¦‚æœæ²¡æœ‰åŠ çš„åŒå­¦å¯ä»¥å†åŠ ä¸€æ¬¡ã€‚

```xml
  <build_depend>sensor_msgs</build_depend>
  <build_depend>rosidl_default_generators</build_depend>
  <exec_depend>rosidl_default_runtime</exec_depend>
  <member_of_group>rosidl_interface_packages</member_of_group>
```

### [2.6ç¼–è¯‘](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_26ç¼–è¯‘)

åœ¨vscodeä¸­ï¼Œä½¿ç”¨`Ctrl+Shift+~`æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œåœ¨`town_ws`ç›®å½•ä¸‹è¾“å…¥ï¼š

```shell
colcon build --packages-select village_interfaces
```

![image-20210811163033796](assets/image-20210811163033796.png)

### [2.7æµ‹è¯•](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_27æµ‹è¯•)

è¿™æ¬¡æµ‹è¯•æˆ‘ä»¬ä¾ç„¶ä½¿ç”¨`ros2 interface`æŒ‡ä»¤è¿›è¡Œæµ‹è¯•ã€‚

ä¹‹å‰å·²ç»æµ‹è¯•è¿‡äº†è¯é¢˜äº†ï¼Œè¿™é‡Œå°é±¼å°±åªæ”¾ä¸€ä¸‹æµ‹è¯•æŒ‡ä»¤å’Œæµ‹è¯•ç»“æœã€‚

```
source install/setup.bash 
ros2 interface package village_interfaces
ros2 interface show village_interfaces/srv/BorrowMoney
ros2 interface proto village_interfaces/srv/BorrowMoney 
```

> æ³¨æ„ï¼Œ`ros2 interface proto` è¯¥æŒ‡ä»¤ç›®å‰åªæ˜¾ç¤ºå‡ºè¯·æ±‚éƒ¨åˆ†è¯é¢˜æ•°æ®

![image-20210816145858746](assets/image-20210816145858746.png)

## [3.åˆ›å»ºä¹°ä¹¦æœåŠ¡æ¥å£](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_3åˆ›å»ºä¹°ä¹¦æœåŠ¡æ¥å£)

### [3.1 ç¡®è®¤æ•°æ®ç»“æ„](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_31-ç¡®è®¤æ•°æ®ç»“æ„)

å’Œåˆ›å»ºå€Ÿé’±æœåŠ¡ä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆç¡®å®šç‹äºŒå–ä¹¦çš„æ•°æ®ç»“æ„ã€‚

ä¸Šä¸€èŠ‚ä¸­ç‹äºŒå¯¹å–ä¹¦çš„è¦æ±‚å¦‚ä¸‹ï¼š

1. å¿…é¡»ä¸€æ‰‹äº¤é’±ï¼Œä¸€æ‰‹äº¤è´§ï¼Œçˆ±ä¹°ä¸ä¹°ğŸ˜
2. æ¯æ¬¡ç»™å¤šå°‘é’±å–å¤šå°‘ç« ï¼Œæ¯ç« ä¸€å—é’±ï¼Œå¦‚æœæ‰‹é‡Œçš„å­˜è´§ä¸è¶³ï¼Œå°±ç»§ç»­ç­‰å¾…

æ€»ç»“ä¸€ä¸‹ï¼Œç‹äºŒæä¾›ä¹¦çš„æ—¶å€™ï¼Œä¸€å®šè¦å…ˆç»™é’±æ‰è¡Œï¼Œæ‰€ä»¥å¼ ä¸‰åªéœ€è¦ç»™é’±å°±è¡Œï¼ŒæœåŠ¡çš„è¯·æ±‚æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

- ä¹°ä¹¦çš„é’±ï¼Œæ— ç¬¦å·æ•´å½¢ï¼Œ`uint32`

é‚£ç‹äºŒè¿”å›ä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºç‹äºŒå¯¹åº”çš„æ•°é‡è‰³å¨˜ä¼ å¥‡ï¼Œæ‰€ä»¥ç‹äºŒçš„è¿”å›å°±æ˜¯nç« å°è¯´ã€‚

ä¸€ç« èŠ‚çš„å°è¯´æˆ‘ä»¬å¯ä»¥é‡‡ç”¨`string`æ¥ï¼Œé‚£nç« èŠ‚çš„å°è¯´è¯¥æ€ä¹ˆåŠï¼ŸåŠæ³•å°±æ˜¯ç”¨`string`æ•°ç»„æ¥å®¹çº³å¤šä¸ªç« èŠ‚ã€‚

- æ‰€ä»¥ç‹äºŒçš„è¿”å›æ˜¯ä¸€ä¸ª`string`ç±»å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºå¤šä¸ªç« èŠ‚çš„ä¹¦

### [3.2 åˆ›å»º`srv`æ–‡ä»¶å¤¹åŠ`SellNovel.srv`æ¶ˆæ¯æ–‡ä»¶](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_32-åˆ›å»ºsrvæ–‡ä»¶å¤¹åŠsellnovelsrvæ¶ˆæ¯æ–‡ä»¶)

ä¸Šé¢æˆ‘ä»¬å·²ç»åˆ›å»ºäº†`srv`ï¼Œè¿™é‡Œç›´æ¥åˆ›å»º`SellNovel.srv`

```
cd src/village_interfaces
cd srv
touch SellNovel.srv
```

åˆ›å»ºå®Œæˆåçš„ç›®å½•ç»“æ„

![image-20210812173303503](assets/image-20210812173303503.png)

### [3.3 ç¼–å†™æ–‡ä»¶å†…å®¹](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_33-ç¼–å†™æ–‡ä»¶å†…å®¹)

ç”¨æ— ç¬¦å·æ•´å½¢è¡¨ç¤º`money`å¤§å®¶å·²ç»å¾ˆæ¸…æ¥šå¦‚ä½•åšäº†ï¼Œé‚£å¦‚ä½•è¡¨ç¤ºå°è¯´æ•°ç»„å‘¢ï¼Ÿå…¶å®åªéœ€åœ¨ç±»å‹çš„åé¢åŠ ä¸Š`[]`ä¸­æ‹¬å·ã€‚

å®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š

```
uint32 money
---
string[] novels
```

è¯·æ±‚æ—¶ç»™é’±ï¼Œè¿”å›å³ä¸ºå¤šç« å°è¯´ã€‚

### [3.4ä¿®æ”¹`CMakeLists.txt`](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_34ä¿®æ”¹cmakeliststxt)

åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œå†æ·»åŠ ä¸Šä¸€è¡Œ`"srv/SellNovel.srv"`ä»£ç å³å¯ï¼š

```
rosidl_generate_interfaces(${PROJECT_NAME}
  #---msg---
  "msg/Novel.msg"
  #---srv---
  "srv/BorrowMoney.srv"
  "srv/SellNovel.srv"
   DEPENDENCIES sensor_msgs
 )
```

### [3.5ä¿®æ”¹`package.xml`](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_35ä¿®æ”¹packagexml)

åŒæ ·çš„ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ä¿®æ”¹è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸éœ€è¦ä¿®æ”¹äº†ã€‚

### [3.6ç¼–è¯‘](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_36ç¼–è¯‘)

åœ¨vscodeä¸­ï¼Œä½¿ç”¨`Ctrl+Shift+~`æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œåœ¨`town_ws`ç›®å½•ä¸‹è¾“å…¥ï¼š

```shell
cd ~/town_ws
colcon build --packages-select village_interfaces
```

![image-20210811163033796](assets/image-20210811163033796-176708607831329.png)

### [3.7æµ‹è¯•](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_37æµ‹è¯•)

è¿™æ¬¡æµ‹è¯•æˆ‘ä»¬ä¾ç„¶ä½¿ç”¨`ros2 interface`æŒ‡ä»¤è¿›è¡Œæµ‹è¯•ã€‚

ä¹‹å‰å·²ç»æµ‹è¯•è¿‡äº†è¯é¢˜äº†ï¼Œè¿™é‡Œå°é±¼å°±åªæ”¾ä¸€ä¸‹æµ‹è¯•æŒ‡ä»¤å’Œæµ‹è¯•ç»“æœã€‚

```
source install/setup.bash 
ros2 interface package village_interfaces
ros2 interface show village_interfaces/srv/SellNovel
ros2 interface proto village_interfaces/srv/SellNovel 
```

> æ³¨æ„ï¼Œ`ros2 interface proto`è¯¥æŒ‡ä»¤ç›®å‰åªæ˜¾ç¤ºå‡ºè¯·æ±‚éƒ¨åˆ†è¯é¢˜æ•°æ®

![image-20210816150038830](assets/image-20210816150038830.png)

## [4.æ€»ç»“](https://fishros.com/d2lros2foxy/#/chapt4/4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£?id=_4æ€»ç»“)

æœ¬èŠ‚å°é±¼å¸¦å¤§å®¶åˆ›å»ºäº†ç”¨äºå€Ÿé’±å’Œä¹°ä¹¦çš„æœåŠ¡æ¥å£ï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬å°±å¼€å§‹ç¼–å†™ä»£ç ï¼Œå®Œæˆå€Ÿé’±æœåŠ¡ã€‚

# [4.5.2 PythonæœåŠ¡é€šä¿¡å®ç°(æä¸‰å€Ÿé’±)](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_452-pythonæœåŠ¡é€šä¿¡å®ç°æä¸‰å€Ÿé’±)

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°é±¼ã€‚ä¸ŠèŠ‚è¯´å®Œå¦‚ä½•è‡ªå®šä¹‰ROS2çš„æœåŠ¡æ¥å£ã€‚

ç›¸ä¿¡ä½ å·²ç»è¿«ä¸åŠå¾…çš„æƒ³å°è¯•ä¸€ä¸‹ç¼–å†™ä»£ç äº†ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥åŠ¨æ‰‹,è®©æä¸‰æˆåŠŸå€Ÿé’±ï¼Œåƒä¸Šéº»è¾£çƒ«å§ã€‚

## [1.å¦‚ä½•ç¼–å†™ä¸€ä¸ªPythonæœåŠ¡](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_1å¦‚ä½•ç¼–å†™ä¸€ä¸ªpythonæœåŠ¡)

å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¯´ä¸€ä¸‹åˆ›å»ºROS2æœåŠ¡ç«¯åŸºæœ¬æ­¥éª¤ã€‚

é¦–å…ˆæ˜¯æœåŠ¡ç«¯ï¼š

1. å¯¼å…¥æœåŠ¡æ¥å£
2. åˆ›å»ºæœåŠ¡ç«¯å›è°ƒå‡½æ•°
3. å£°æ˜å¹¶åˆ›å»ºæœåŠ¡ç«¯
4. ç¼–å†™å›è°ƒå‡½æ•°é€»è¾‘å¤„ç†è¯·æ±‚

## [2.ç¼–å†™æœåŠ¡ç«¯æå››ä»£ç ](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_2ç¼–å†™æœåŠ¡ç«¯æå››ä»£ç )

æˆ‘ä»¬å…ˆæ¥åˆ›å»ºæå››è¿™è¾¹çš„æœåŠ¡ç«¯ã€‚ç”¨VsCodeæ‰“å¼€æˆ‘ä»¬çš„`town_ws`å·¥ä½œåŒºã€‚

### [2.1 å¯¼å…¥æœåŠ¡æ¥å£](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_21-å¯¼å…¥æœåŠ¡æ¥å£)

æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­è‡ªå®šä¹‰çš„æœåŠ¡æ¥å£è¿™é‡Œè¯¥æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ

éœ€è¦ä¸‹é¢ä¸¤ä¸ªæ­¥éª¤ï¼š

#### [2.1.1 æ·»åŠ ä¾èµ–](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_211-æ·»åŠ ä¾èµ–)

å¯¼å…¥ä¾èµ–æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©æˆ‘ä»¬çš„ä»£ç æ‰¾åˆ°å¯¹åº”çš„æ¥å£ã€‚

å› ä¸º`village_li`æ˜¯åŒ…ç±»å‹æ˜¯`ament_python`è¿™é‡Œåªéœ€è¦åœ¨`package.xml`ä¸­åŠ å…¥ä¸‹é¢çš„ä»£ç å³å¯ï¼š

```xml
  <depend>village_interfaces</depend>
```

![image-20210816153438400](assets/image-20210816153438400.png)

#### [2.1.2 ç¨‹åºä¸­å¯¼å…¥](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_212-ç¨‹åºä¸­å¯¼å…¥)

ç¨‹åºä¸­å¯¼å…¥ä¹Ÿæ˜¯åªéœ€è¦ä¸€è¡Œä»£ç å³å¯å®Œæˆï¼Œæ‰“å¼€li4.pyï¼Œåœ¨æ–‡ä»¶å¼€å¤´åŠ å…¥ä¸‹é¢ä¸€è¡Œä»£ç ã€‚

```python
#ä»æ‘åº„æ¥å£æœåŠ¡ç±»ä¸­å¯¼å…¥å€Ÿé’±æœåŠ¡
from village_interfaces.srv import BorrowMoney
```

### [2.2 åˆ›å»ºæœåŠ¡ç«¯å¹¶å®šä¹‰æœåŠ¡å›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_22-åˆ›å»ºæœåŠ¡ç«¯å¹¶å®šä¹‰æœåŠ¡å›è°ƒå‡½æ•°)

#### [2.2.1åˆ›å»ºæœåŠ¡ç«¯](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_221åˆ›å»ºæœåŠ¡ç«¯)

æ¥ç€åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼Œç»§æ‰¿äº`Node`ä¹‹åï¼Œ`WriterNode`ä¹Ÿå…·å¤‡äº†åˆ›å»ºä¸€ä¸ªæœåŠ¡çš„èƒ½åŠ›ã€‚åœ¨`WriterNode`çš„`__init__`å‡½æ•°ä¸­åˆ›å»ºæˆå‘˜å˜é‡`borrow_server`ã€‚

```python
# æ–°å»ºå€Ÿé’±æœåŠ¡
self.borrow_server = self.create_service(BorrowMoney, "borrow_money", self.borrow_money_callback)
```

éœ€è¦ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼š

- <font color=red>æœåŠ¡æ¥å£ç±»å‹</font>ï¼Œ`BorrowMoney`ï¼Œæˆ‘ä»¬åœ¨2.1.2å¯¼å…¥çš„

- <font color=red>æœåŠ¡åç§°</font>ï¼Œ`"borrow_money"`ï¼Œå…·æœ‰å”¯ä¸€æ€§ï¼Œè‡ªå·±æ‰‹æ‰“çš„

- <font color=red>å›è°ƒå‡½æ•°</font>ï¼Œ`self.borrow_money_callback`ï¼Œæˆ‘ä»¬ä¸‹ä¸€æ­¥å®šä¹‰çš„ã€‚

  > å…³äºå›è°ƒå‡½æ•°å°é±¼å†™è¿‡ä¸€ç¯‡æ–‡ç« ï¼š[å›è°ƒå‡½æ•°ä¸å¼‚æ­¥æ‰§è¡Œ](./4.8è¡¥å……å›è°ƒå‡½æ•°.md)ï¼Œä¸ç†è§£çš„åŒå­¦å¯ä»¥çœ‹ä¸€çœ‹

#### [2.2.2 å®šä¹‰å›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_222-å®šä¹‰å›è°ƒå‡½æ•°)

```python
def borrow_money_callback(self,request, response):
    """
    å€Ÿé’±å›è°ƒå‡½æ•°
    å‚æ•°ï¼šrequest å®¢æˆ·ç«¯è¯·æ±‚å¯¹è±¡ï¼Œæºå¸¦ç€æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®
         response æœåŠ¡ç«¯å“åº”ï¼Œè¿”å›æœåŠ¡ç«¯çš„å¤„ç†ç»“æœ
    è¿”å›å€¼ï¼šresponse
    """
    return response
```

è¿™ä¸ªå‡½æ•°æœ‰ä¸‰ä¸ªå…¥å£å‚æ•°,selfä»£è¡¨æœ¬èº«ï¼Œè¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œç±»ä¼¼äºc++å’Œjavaé‡Œçš„thisã€‚

- <font color=red>request æ˜¯å®¢æˆ·ç«¯è¯·æ±‚å¯¹è±¡ï¼Œæºå¸¦ç€æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®</font>ã€‚

  å…¶ç»“æ„å°±æ˜¯ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬æ‰€å®šä¹‰çš„`name`å’Œ`money`ç»„æˆ

- <font color=red>response æ˜¯æœåŠ¡ç«¯å“åº”ï¼Œè¿”å›æœåŠ¡ç«¯çš„å¤„ç†ç»“æœ</font>

  å…¶ç»“æ„ç”±`success`å’Œ`money`ç»„æˆ

### [2.3ç¼–å†™å›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_23ç¼–å†™å›è°ƒå‡½æ•°)

æ¥ä¸‹æ¥å¼€å§‹æ­£å¼ç¼–å†™å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°çš„è¾“å…¥æ˜¯requestå’Œresponseï¼Œè¾“å‡ºæ˜¯æˆ‘ä»¬å¤„ç†åçš„reponse(å½“ç„¶ä¹Ÿå¯ä»¥ä¸å¤„ç†ï¼Œä½¿ç”¨é»˜è®¤å€¼)

```python
def borrow_money_callback(self,request, response):
    """
    å€Ÿé’±å›è°ƒå‡½æ•°
    å‚æ•°ï¼šrequest å®¢æˆ·ç«¯è¯·æ±‚
         response æœåŠ¡ç«¯å“åº”
    è¿”å›å€¼ï¼šresponse
    """
    self.get_logger().info("æ”¶åˆ°æ¥è‡ª: %s çš„å€Ÿé’±è¯·æ±‚ï¼Œç›®å‰è´¦æˆ·å†…è¿˜æœ‰%då…ƒ" % (request.name, self.account))
    #æ ¹æ®æå››å€Ÿé’±è§„åˆ™ï¼Œå€Ÿå‡ºå»çš„é’±ä¸èƒ½å¤šäºè‡ªå·±æ‰€æœ‰é’±çš„ååˆ†ä¹‹ä¸€ï¼Œä¸ç„¶å°±ä¸å€Ÿ
    if request.money <= int(self.account*0.1):
        response.success = True
        response.money = request.money
        self.account = self.account - request.money
        self.get_logger().info("å€Ÿé’±æˆåŠŸï¼Œå€Ÿå‡º%d å…ƒ ,ç›®å‰è´¦æˆ·ä½™é¢%d å…ƒ" % (response.money,self.account))
    else:
        response.success = False
        response.money = 0
        self.get_logger().info("å¯¹ä¸èµ·å…„å¼Ÿï¼Œæ‰‹å¤´ç´§,ä¸èƒ½å€Ÿç»™ä½ ")
    return response
```

è¿™é‡Œä»£ç å…¶å®å¹¶ä¸å¤æ‚ï¼Œå…ˆåˆ¤æ–­è¦å€Ÿé’±çš„é‡‘é¢æ˜¯å¦æ»¡è¶³è¦å€Ÿå‡ºå»çš„æ•°é‡ï¼Œå¦‚æœæ»¡è¶³åˆ™å€Ÿï¼Œä¸ç„¶å°±ä¸å€Ÿã€‚

ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¸ºæå››çš„å…‰å¤´è´¦æˆ·æ‰“èµ70å—é’±ï¼Œå°†`__init__`å‡½æ•°ä¸­çš„self.account é»˜è®¤è´¦æˆ·å€¼æ”¹ä¸º70å³å¯

è‡³æ­¤ï¼ŒæœåŠ¡ç«¯çš„ä»£ç å°±ç¼–å†™å®Œæˆäº†ï¼Œå®Œæ•´ç‰ˆä»£ç å¯ä»¥ç‚¹å¼€[è¿™ä¸ªç½‘å€](https://raw.githubusercontent.com/fishros/ros2_town/master/village_li/village_li/li4.py)æŸ¥çœ‹

## [3.æµ‹è¯•æœåŠ¡ç«¯ä»£ç ](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_3æµ‹è¯•æœåŠ¡ç«¯ä»£ç )

### [3.1ç¼–è¯‘è¿è¡Œ](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_31ç¼–è¯‘è¿è¡Œ)

åœ¨vscodeä¸­ï¼Œä½¿ç”¨`Ctrl+Shift+~`æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œåœ¨`town_ws`ç›®å½•ä¸‹è¾“å…¥ï¼š

```shell
colcon build --packages-select village_li
```

![image-20210816163422495](https://fishros.com/d2lros2foxy/chapt4/4.9æœåŠ¡å®ç°(Python)/imgs/image-20210816163422495.png)

### [3.2å¯åŠ¨å¹¶æŸ¥çœ‹æœåŠ¡åˆ—è¡¨](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_32å¯åŠ¨å¹¶æŸ¥çœ‹æœåŠ¡åˆ—è¡¨)

å…ˆ`source`ï¼Œå†`run`

```
source install/setup.bash
ros2 run village_li li4_node
```

![image-20210816163704618](https://fishros.com/d2lros2foxy/chapt4/4.9æœåŠ¡å®ç°(Python)/imgs/image-20210816163704618.png)

### [3.3æ‰‹åŠ¨è°ƒç”¨](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_33æ‰‹åŠ¨è°ƒç”¨)

åœ¨VsCodeä¸­ä½¿ç”¨`Ctrl+Shift+5`æ‰“å¼€ä¸€ä¸ªåˆ‡åˆ†ç»ˆç«¯ã€‚ç„¶åä¾æ¬¡è¾“å…¥ä¸‹é¢çš„æŒ‡ä»¤ï¼ŒæŸ¥çœ‹æˆ‘ä»¬çš„æœåŠ¡ã€‚

```bash
ros2 service list #æœåŠ¡åˆ—è¡¨
ros2 service list -t #æœåŠ¡åˆ—è¡¨å¸¦ç±»å‹
```

![image-20251231093558110](assets/image-20251231093558110.png)

![image-20251231093622803](assets/image-20251231093622803.png)

æ¥ç€æˆ‘ä»¬ä½¿ç”¨å‘½ä»¤è¡Œæ¥æ‰‹åŠ¨è°ƒç”¨æœåŠ¡ï¼Œä¸çŸ¥é“ä½ è¿˜æ˜¯å¦è®°å¾—4.7ä¸­æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨æœåŠ¡å°†ä¸¤ä¸ªæ•°å­—ç›¸åŠ ã€‚

è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨æœåŠ¡ç”¨æä¸‰çš„åä¹‰æ¥å€Ÿ5å—é’±

```bash
source install/setup.bash
# "{name: 'li3', money: 5}" å†’å·åå¿…é¡»æœ‰ç©ºæ ¼
ros2 service call /borrow_money village_interfaces/srv/BorrowMoney  "{name: 'li3', money: 5}"
```

çœ‹è¿”å›ç»“æœsuccessä¸ºTrueï¼Œmoneyçš„å€¼ä¹Ÿå˜æˆäº†5ï¼Œè¯´æ˜æä¸‰å€Ÿé’±æˆåŠŸäº†ã€‚

![image-20210816164314308](https://fishros.com/d2lros2foxy/chapt4/4.9æœåŠ¡å®ç°(Python)/imgs/image-20210816164314308.png)

å†å°è¯•å€Ÿ50å—é’±çœ‹çœ‹æå››å€Ÿä¸å€Ÿã€‚

```bash
ros2 service call /borrow_money village_interfaces/srv/BorrowMoney  "{name: 'li3', money: 50}"
```

è¿™æ¬¡æå››è¯´ä»–æ‰‹å¤´ç´§ï¼Œä¸ç»™å€Ÿã€‚è¿”å›å€¼ä¸­çš„successä¹Ÿå˜æˆäº†Falseï¼Œmoneyä¹Ÿå˜æˆäº†0ã€‚

![image-20210816164511430](https://fishros.com/d2lros2foxy/chapt4/4.9æœåŠ¡å®ç°(Python)/imgs/image-20210816164511430.png)

## [4.ç¼–å†™å®¢æˆ·ç«¯ä»£ç ](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_4ç¼–å†™å®¢æˆ·ç«¯ä»£ç )

æœåŠ¡ç«¯æå®šäº†åï¼Œæˆ‘ä»¬æ¥ç¼–å†™å®¢æˆ·ç«¯æä¸‰è¿™è¾¹çš„ä»£ç ã€‚

ç¼–å†™æœåŠ¡é€šä¿¡çš„å®¢æˆ·ç«¯çš„ä¸€èˆ¬æ­¥éª¤ï¼š

1. å¯¼å…¥æœåŠ¡æ¥å£
2. åˆ›å»ºè¯·æ±‚ç»“æœæ¥æ”¶å›è°ƒå‡½æ•°
3. å£°æ˜å¹¶åˆ›å»ºå®¢æˆ·ç«¯
4. ç¼–å†™ç»“æœæ¥æ”¶é€»è¾‘
5. è°ƒç”¨å®¢æˆ·ç«¯å‘é€è¯·æ±‚

### [4.1å¯¼å…¥æœåŠ¡æ¥å£](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_41å¯¼å…¥æœåŠ¡æ¥å£)

ç¬¬ä¸€æ­¥å’ŒæœåŠ¡ç«¯ç›¸åŒï¼Œå¯¼å…¥å¯¹åº”çš„æ¥å£ï¼Œå› ä¸ºæå››å’Œæä¸‰æ˜¯åœ¨åŒä¸€ä¸ªåŒ…`village_li`å†…,æ‰€ä»¥ä¸éœ€è¦å†æ¬¡ä¿®æ”¹`package.xml`ã€‚

æ‰“å¼€`li3.py`æˆ‘ä»¬ç›´æ¥å¯¼å…¥å¯¹åº”æ¥å£

```python
from village_interfaces.srv import BorrowMoney
```

### [4.2åˆ›å»ºè¯·æ±‚ç»“æœæ¥æ”¶å›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_42åˆ›å»ºè¯·æ±‚ç»“æœæ¥æ”¶å›è°ƒå‡½æ•°)

ç¼–å†™`borrow_respoonse_callback`å€Ÿé’±ç»“æœå›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„åªæœ‰ä¸€ä¸ªå…¥å£å‚æ•°`response`

```python
def borrow_respoonse_callback(self,response):
    """
    å€Ÿé’±ç»“æœå›è°ƒ
    """
    pass
```

### [4.3åˆ›å»ºå®¢æˆ·ç«¯å¹¶å®šä¹‰ç»“æœå›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_43åˆ›å»ºå®¢æˆ·ç«¯å¹¶å®šä¹‰ç»“æœå›è°ƒå‡½æ•°)

æä¸‰ç»§æ‰¿äºNodeï¼Œä¹Ÿå…·å¤‡äº†åˆ›å»ºå®¢æˆ·ç«¯çš„èƒ½åŠ›

```python
class BaiPiaoNode(Node): #BaiPiaoNodeæ˜¯ç»§æ‰¿äºNode
```

åˆ›å»ºå®¢æˆ·ç«¯

```python
#åœ¨__init__å‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ªæœåŠ¡çš„å®¢æˆ·ç«¯
self.borrow_money_client_ = self.create_client(BorrowMoney, "borrow_money")
```

åˆ›å»ºå®¢æˆ·ç«¯ä½¿ç”¨å‡½æ•°`create_client`è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå…¥å£å‚æ•°ï¼Œä¸€ä¸ªæ˜¯æœåŠ¡æ¥å£ç±»å‹ï¼Œä¸€ä¸ªæ˜¯æœåŠ¡åç§°ã€‚

> è¿™é‡Œçš„ä¸¤ä¸ªå‚æ•°éœ€å’ŒæœåŠ¡ç«¯çš„å®Œå…¨ä¸€è‡´ï¼Œæ–¹å¯é€šä¿¡ã€‚åå­—ä¸ä¸€è‡´ï¼Œä¼šæ‰¾ä¸åˆ°å¯¹åº”æœåŠ¡ï¼Œæ•°æ®ç±»å‹ä¸ä¸€è‡´ä¼šå¯¼è‡´æ— æ³•é€šä¿¡ã€‚

### [4.4 ç¼–å†™ç»“æœå›è°ƒå‡½æ•°å¤„ç†é€»è¾‘](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_44-ç¼–å†™ç»“æœå›è°ƒå‡½æ•°å¤„ç†é€»è¾‘)

æ ¹æ®ç»“æœè¯´ä¸åŒçš„è¯

```python
    def borrow_respoonse_callback(self,response):
        """
        å€Ÿé’±ç»“æœå›è°ƒ
        """
        # æ‰“å°ä¸€ä¸‹ä¿¡æ¯
        result = response.result()
        if result.success == True:
            self.get_logger().info("æœç„¶æ˜¯äº²å¼Ÿå¼Ÿï¼Œå€Ÿåˆ°%d,åƒéº»è¾£çƒ«å»äº†" % result.money)
        else:
            self.get_logger().info("å®³ï¼Œè¿å‡ å—é’±éƒ½ä¸å€Ÿ,æˆ‘è¿˜æ˜¯ä¸æ˜¯ä»–äº²å“¥äº†ï¼Œä¸–æ€ç‚å‡‰å‘€")
```

### [4.5 ç¼–å†™å‘é€è¯·æ±‚é€»è¾‘](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_45-ç¼–å†™å‘é€è¯·æ±‚é€»è¾‘)

#### [4.5.1åˆ›å»ºå‘é€è¯·æ±‚å‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_451åˆ›å»ºå‘é€è¯·æ±‚å‡½æ•°)

æ¥ç€æˆ‘ä»¬åœ¨`BaiPiaoNodeä¸­`ç¼–å†™ä¸€ä¸ªå‡½æ•°ç”¨äºåˆ›å»ºå‘é€çš„æ•°æ®ï¼Œå¹¶å‘é€è¯·æ±‚ã€‚

```python
def borrow_money_eat(self):
    """
    å€Ÿé’±åƒéº»è¾£çƒ«å‡½æ•°
    """
    #æ‰“å°ä¸€å¥è¯
    self.get_logger().info("æ‰¾æˆ‘å¼Ÿå€Ÿé’±åƒéº»è¾£çƒ«å–½")
    #ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼Œæ¯1sæ£€æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœæœåŠ¡æ²¡æœ‰å¯åŠ¨ï¼Œåˆ™ä¸€ç›´å¾ªç¯
    while not self.borrow_money_client_.wait_for_service(1.0):
        self.get_logger().warn("æˆ‘å¼Ÿä¸åœ¨çº¿ï¼Œæˆ‘å†ç­‰ç­‰ã€‚")
    # æ„å»ºè¯·æ±‚å†…å®¹
    request = BorrowMoney.Request()
    #å°†å½“å‰èŠ‚ç‚¹åç§°ä½œä¸ºå€Ÿé’±è€…å§“å
    request.name = self.get_name()
    #å€Ÿé’±é‡‘é¢10å…ƒ
    request.money = 10
    #å‘é€å¼‚æ­¥å€Ÿé’±è¯·æ±‚ï¼Œå€Ÿé’±æˆåŠŸåå°±è°ƒç”¨borrow_respoonse_callback()å‡½æ•°
    self.borrow_money_client_.call_async(request).add_done_callback(self.borrow_respoonse_callback)
```

å°é±¼æ¥è®²ä¸€è®²è¿™ä¸ªä»£ç 

- `wait_for_service(1.0)`ç”¨äºç­‰å¾…æœåŠ¡ä¸Šçº¿ï¼Œè¿™æ˜¯ä¸€ç§å¾ˆä¼˜é›…çš„åšæ³•ï¼Œè°ƒç”¨ä¹‹å‰æ£€æµ‹ä¸€ä¸‹æœåŠ¡æ˜¯å¦åœ¨çº¿
- `call_async(request).add_done_callback`è¿™é‡Œæ˜¯ä»£ç çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œç”¨äºå‘é€è¯·æ±‚ï¼Œå¹¶ä¸”æ·»åŠ äº†ä¸€ä¸ªä»»åŠ¡å®Œæˆæ—¶çš„å›è°ƒå‡½æ•°`borrow_respoonse_callback`

#### [4.5.2ä¿®æ”¹mainå‡½æ•°è°ƒç”¨å‘é€è¯·æ±‚å‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_452ä¿®æ”¹mainå‡½æ•°è°ƒç”¨å‘é€è¯·æ±‚å‡½æ•°)

å› ä¸ºå‘é€è¯·æ±‚çš„å‡½æ•°æ˜¯BaiPiaoNodeçš„æˆå‘˜å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥è°ƒç”¨BaiPiaoNodeæ¥å‘é€è¯·æ±‚å³å¯ï¼Œå¯ä»¥å°†mainå‡½æ•°åšå¦‚ä¸‹ä¿®æ”¹ï¼ˆå…¶å®åªå¢åŠ äº†ä¸€è¡Œä»£ç è€Œå·²ï¼‰ã€‚

```python
def main(args=None):
    """
    ros2è¿è¡Œè¯¥èŠ‚ç‚¹çš„å…¥å£å‡½æ•°ï¼Œå¯é…ç½®å‡½æ•°åç§°
    """
    rclpy.init(args=args) # åˆå§‹åŒ–rclpy
    node = BaiPiaoNode()  # æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹
    node.borrow_money_eat() #å¢åŠ ä¸€è¡Œï¼Œæä¸‰å€Ÿé’±
    rclpy.spin(node) # ä¿æŒèŠ‚ç‚¹è¿è¡Œï¼Œæ£€æµ‹æ˜¯å¦æ”¶åˆ°é€€å‡ºæŒ‡ä»¤ï¼ˆCtrl+Cï¼‰  
    rclpy.shutdown() # rclå…³é—­
```

ç¼–å†™å¥½å®¢æˆ·ç«¯ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åšæ•´ä½“çš„æµ‹è¯•äº†ï¼Œä½†è¦è®°å¾—ç¼–è¯‘ç¨‹åºå“¦ã€‚å®Œæ•´çš„li3.pyä»£ç å¯ä»¥[è®¿é—®è¿™é‡Œ](https://raw.githubusercontent.com/fishros/ros2_town/master/village_li/village_li/li3.py)è·å–

> é™¤äº†ä½¿ç”¨`call_async(request)`å¼‚æ­¥è°ƒç”¨ï¼Œè¿˜æœ‰ä¸€ç§åŒæ­¥è°ƒç”¨çš„æ–¹å¼ï¼Œä½†å°é±¼å¹¶ä¸æ¨èï¼ŒåŸå› è¿™é‡Œå°é±¼`mark@é±¼é¦™ROS`ä¸€ä¸‹ï¼Œåé¢åœ¨å…¬ä¼—å·ä¸­å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« ä»‹ç»ã€‚

## [5.æ•´ä½“æµ‹è¯•](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_5æ•´ä½“æµ‹è¯•)

```python
# å®¢æˆ·ç«¯
import rclpy
from rclpy.node import Node
from std_msgs.msg import String
from village_interfaces.srv import BorrowMoney

class BaiPiaoNode(Node):
    def __init__(self, name):
        super().__init__(name)
        self.get_logger().info("å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æä¸‰ï¼Œæå››ä»–å“¥,æˆ‘æ˜¯ä¸€åç™½å«–è€…ï¼")
        # self.sub_novel = self.create_subscription(String, "sexy_girl", self.recv_novel_callback, 10)
        self.borrow_money_client_ = self.create_client(BorrowMoney, "borrow_money")

    def recv_novel_callback(self, novel):
        self.get_logger().info('æä¸‰ï¼šæˆ‘æ”¶åˆ°äº†å°è¯´å†…å®¹ï¼š"%s"' % novel.data)

    def borrow_respoonse_callback(self, response):
        """
        å€Ÿé’±ç»“æœå›è°ƒ
        """
        # æ‰“å°ä¸€ä¸‹ä¿¡æ¯
        result = response.result()
        if result.success == True:
            self.get_logger().info("æœç„¶æ˜¯äº²å¼Ÿå¼Ÿï¼Œå€Ÿåˆ°%d,åƒéº»è¾£çƒ«å»äº†" % result.money)
        else:
            self.get_logger().info("å®³ï¼Œè¿å‡ å—é’±éƒ½ä¸å€Ÿ,æˆ‘è¿˜æ˜¯ä¸æ˜¯ä»–äº²å“¥äº†ï¼Œä¸–æ€ç‚å‡‰å‘€")
        pass
    
    def borrow_money_eat(self):
        """
        å€Ÿé’±åƒéº»è¾£çƒ«å‡½æ•°
        """
        #æ‰“å°ä¸€å¥è¯
        self.get_logger().info("æ‰¾æˆ‘å¼Ÿå€Ÿé’±åƒéº»è¾£çƒ«å–½")
        #ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼Œæ¯1sæ£€æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœæœåŠ¡æ²¡æœ‰å¯åŠ¨ï¼Œåˆ™ä¸€ç›´å¾ªç¯
        while not self.borrow_money_client_.wait_for_service(1.0):
            self.get_logger().warn("æˆ‘å¼Ÿä¸åœ¨çº¿ï¼Œæˆ‘å†ç­‰ç­‰ã€‚")
        # æ„å»ºè¯·æ±‚å†…å®¹
        request = BorrowMoney.Request()
        #å°†å½“å‰èŠ‚ç‚¹åç§°ä½œä¸ºå€Ÿé’±è€…å§“å
        request.name = self.get_name()
        #å€Ÿé’±é‡‘é¢10å…ƒ
        request.money = 10
        #å‘é€å¼‚æ­¥å€Ÿé’±è¯·æ±‚ï¼Œå€Ÿé’±æˆåŠŸåå°±è°ƒç”¨borrow_respoonse_callback()å‡½æ•°
        self.borrow_money_client_.call_async(request).add_done_callback(self.borrow_respoonse_callback)

def main(args=None):
    rclpy.init(args=args)
    node = BaiPiaoNode("li8")
    node.borrow_money_eat() #å¢åŠ ä¸€è¡Œï¼Œæä¸‰å€Ÿé’±
    rclpy.spin(node)
    rclpy.shutdown()
```

```python
# æœåŠ¡ç«¯
#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
# 1. å¯¼å…¥æ¶ˆæ¯ç±»å‹
from std_msgs.msg import String
from std_msgs.msg import UInt32
from village_interfaces.srv import BorrowMoney
#å¯¼å…¥ç³»ç»Ÿå†…ç½®çš„å›¾ç‰‡æ¶ˆæ¯ç±»å‹
from sensor_msgs.msg import Image
#ä»æ‘åº„æ¥å£è¯é¢˜æ¶ˆæ¯ç±»ä¸­å¯¼å…¥å°è¯´æ¶ˆæ¯ç±»å‹
from village_interfaces.msg import Novel


class WriterNode(Node):
    """
    åˆ›å»ºä¸€ä¸ªæå››èŠ‚ç‚¹ï¼Œå¹¶åœ¨åˆå§‹åŒ–æ—¶è¾“å‡ºä¸€ä¸ªè¯
    """
    def __init__(self,name):
        super().__init__(name)
        self.get_logger().info("å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯%s,æˆ‘æ˜¯ä¸€åä½œå®¶ï¼" % name)
        # å£°æ˜å‚æ•°,å‚æ•°åå­—ï¼Œé»˜è®¤å€¼
        self.declare_parameter("write_timer_period",5)
        # 2.åˆ›å»ºå¹¶åˆå§‹åŒ–å‘å¸ƒè€…æˆå‘˜å±æ€§pubnovel
        # å…±æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¯é¢˜ç±»å‹ï¼Œç¬¬äºŒä¸ªæ˜¯è¯é¢˜åç§°ï¼Œç¬¬ä¸‰ä¸ªæ˜¯æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦
        self.pub_novel = self.create_publisher(Novel,"sexy_girl", 10)
        self.borrow_server = self.create_service(BorrowMoney, "borrow_money", self.borrow_money_callback)

        #å£°æ˜ä¸€ä¸ªç©ºçš„å›¾åƒ
        self.image = Image()
        # å¼€å§‹è·å–å›¾ç‰‡
        self.create_subscription(Image,"image",self.recv_image_callback,10)

        #3. ç¼–å†™å‘å¸ƒé€»è¾‘
        # åˆ›å»ºå®šæ—¶å™¨æˆå‘˜å±æ€§timer
        self.i = 0 # i æ˜¯ä¸ªè®¡æ•°å™¨ï¼Œç”¨æ¥ç®—ç« èŠ‚ç¼–å·çš„
        timer_period = 5  #æ¯5så†™ä¸€ç« èŠ‚è¯
        self.timer = self.create_timer(timer_period, self.timer_callback)  #å¯åŠ¨ä¸€ä¸ªå®šæ—¶è£…ç½®ï¼Œæ¯ 1 s,è°ƒç”¨ä¸€æ¬¡time_callbackå‡½æ•°

        # è´¦æˆ·é’±çš„æ•°é‡
        self.account = 70
        # åˆ›å»ºå¹¶åˆå§‹åŒ–è®¢é˜…è€…æˆå‘˜å±æ€§submoney
        self.sub_money = self.create_subscription(UInt32,"sexy_girl_money",self.recv_money_callback,10)

    def recv_image_callback(self,image):
        # self.get_logger().info('æ¥æ”¶åˆ°å›¾ç‰‡â€œ%sâ€' % image.data)
        self.image = image

    def timer_callback(self):
        """
        å®šæ—¶å™¨å›è°ƒå‡½æ•°
        """

        msg = Novel()
        msg.content = 'ç¬¬%då›:æ½‹æ»Ÿæ¹– %d æ¬¡å¶é‡èƒ¡è‰³å¨˜' % (self.i, self.i)
        msg.image = self.image
        self.pub_novel.publish(msg)  #å°†å°è¯´å†…å®¹å‘å¸ƒå‡ºå»
        self.get_logger().info('æå››:æˆ‘å‘å¸ƒäº†è‰³å¨˜ä¼ å¥‡ï¼š"%s"' % msg.content)    #æ‰“å°ä¸€ä¸‹å‘å¸ƒçš„æ•°æ®ï¼Œä¾›æˆ‘ä»¬çœ‹
        self.get_logger().info('æå››:å¹¶ä¸”ä¸ºè‰³å¨˜ä¼ å¥‡é…ä¸Šäº†æ’å›¾ï¼Œé•¿ï¼š"%d"ï¼Œå®½ï¼š%d' % (int(msg.image.height),int(msg.image.width)))    #æ‰“å°ä¸€ä¸‹å‘å¸ƒçš„æ’å›¾å°ºå¯¸ï¼Œä¾›æˆ‘ä»¬çœ‹        
        self.i += 1 #ç« èŠ‚ç¼–å·+1
        
        # å›è°ƒä¹‹åæ›´æ–°å›è°ƒå‘¨æœŸ
        timer_period = self.get_parameter('write_timer_period').get_parameter_value().integer_value
        # æ›´æ–°å›è°ƒå‘¨æœŸ
        self.timer.timer_period_ns = timer_period * (1000*1000*1000)

    def recv_money_callback(self,money):
        """
        4. ç¼–å†™è®¢é˜…å›è°ƒå¤„ç†é€»è¾‘
        """
        self.account += money.data
        self.get_logger().info('æå››ï¼šæˆ‘å·²ç»æ”¶åˆ°äº†%dçš„ç¨¿è´¹' % self.account)

    def borrow_money_callback(self, request, response):
        """
        å€Ÿé’±å›è°ƒå‡½æ•°
        å‚æ•°:request å®¢æˆ·ç«¯è¯·æ±‚å¯¹è±¡ï¼Œæºå¸¦ç€æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®
            response æœåŠ¡ç«¯å“åº”ï¼Œè¿”å›æœåŠ¡ç«¯çš„å¤„ç†ç»“æœ
        è¿”å›å€¼:response
        """
        self.get_logger().info("æ”¶åˆ°æ¥è‡ª: %s çš„å€Ÿé’±è¯·æ±‚ï¼Œç›®å‰è´¦æˆ·å†…è¿˜æœ‰%då…ƒ" % (request.name, self.account))
        #æ ¹æ®æå››å€Ÿé’±è§„åˆ™ï¼Œå€Ÿå‡ºå»çš„é’±ä¸èƒ½å¤šäºè‡ªå·±æ‰€æœ‰é’±çš„ååˆ†ä¹‹ä¸€ï¼Œä¸ç„¶å°±ä¸å€Ÿ
        if request.money <= int(self.account*0.1):
            response.success = True
            response.money = request.money
            self.account = self.account - request.money
            self.get_logger().info("å€Ÿé’±æˆåŠŸï¼Œå€Ÿå‡º%d å…ƒ ,ç›®å‰è´¦æˆ·ä½™é¢%d å…ƒ" % (response.money,self.account))
        else:
            response.success = False
            response.money = 0
            self.get_logger().info("å¯¹ä¸èµ·å…„å¼Ÿï¼Œæ‰‹å¤´ç´§,ä¸èƒ½å€Ÿç»™ä½ ")
        return response



def main(args=None):
    """
    ros2è¿è¡Œè¯¥èŠ‚ç‚¹çš„å…¥å£å‡½æ•°
    1. å¯¼å…¥åº“æ–‡ä»¶
    2. åˆå§‹åŒ–å®¢æˆ·ç«¯åº“
    3. æ–°å»ºèŠ‚ç‚¹
    4. spinå¾ªç¯èŠ‚ç‚¹
    5. å…³é—­å®¢æˆ·ç«¯åº“
    """
    rclpy.init(args=args) # åˆå§‹åŒ–rclpy
    node = WriterNode("li7")  # æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹
    rclpy.spin(node) # ä¿æŒèŠ‚ç‚¹è¿è¡Œï¼Œæ£€æµ‹æ˜¯å¦æ”¶åˆ°é€€å‡ºæŒ‡ä»¤ï¼ˆCtrl+Cï¼‰
    rclpy.shutdown() # å…³é—­rclpy
```



å˜€å˜€å˜€ï¼Œç»ˆäºå¯ä»¥å¼€å§‹æœ€ç»ˆçš„æµ‹è¯•äº†ã€‚

### [5.1ç¼–è¯‘åŠŸèƒ½åŒ…](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_51ç¼–è¯‘åŠŸèƒ½åŒ…)

åœ¨vscodeä¸­ï¼Œä½¿ç”¨`Ctrl+Shift+~`æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œåœ¨`town_ws`ç›®å½•ä¸‹è¾“å…¥ï¼š

```shell
colcon build --packages-select village_li
```

![image-20210816163422495](https://fishros.com/d2lros2foxy/chapt4/4.9æœåŠ¡å®ç°(Python)/imgs/image-20210816163422495.png)

### [5.2è¿è¡Œå®¢æˆ·ç«¯æä¸‰ç¨‹åº](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_52è¿è¡Œå®¢æˆ·ç«¯æä¸‰ç¨‹åº)

#### [5.2.1 source](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_521-source)

```
source install/setup.bash
```

#### [5.2.2 è¿è¡Œå®¢æˆ·ç«¯ä»£ç ](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_522-è¿è¡Œå®¢æˆ·ç«¯ä»£ç )

```
ros2 run village_li li3_node
```

![image-20210817104713043](https://fishros.com/d2lros2foxy/chapt4/4.9æœåŠ¡å®ç°(Python)/imgs/image-20210817104713043.png)

### [5.3è¿è¡ŒæœåŠ¡ç«¯ä»£ç ](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_53è¿è¡ŒæœåŠ¡ç«¯ä»£ç )

#### [5.3.1 åˆ‡åˆ†ç»ˆç«¯å¹¶source](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_531-åˆ‡åˆ†ç»ˆç«¯å¹¶source)

vscodeä¸­ä½¿ç”¨`Ctrl+Shift+5`é‡æ–°åˆ‡åˆ†å‡ºä¸€ä¸ªç»ˆç«¯ï¼Œç„¶åsource

```
source install/setup.bash
```

#### [5.3.2 è¿è¡ŒæœåŠ¡ç«¯æå››ç¨‹åº](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_532-è¿è¡ŒæœåŠ¡ç«¯æå››ç¨‹åº)

```
ros2 run village_li li4_node
```

#### [5.3.3 è¿è¡Œç»“æœ](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_533-è¿è¡Œç»“æœ)

![image-20210817105329996](https://fishros.com/d2lros2foxy/chapt4/4.9æœåŠ¡å®ç°(Python)/imgs/image-20210817105329996.png)

ä»å›¾ç‰‡ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæä¸‰å€Ÿé’±å¤±è´¥äº†ï¼ŒåŸå› 80*0.1=8<10ï¼Œä¸èƒ½å€Ÿç»™æä¸‰åå—é’±ï¼Œç¬¦åˆæå››åšäººåŸåˆ™ï¼Œé‚£ä¸ºäº†æä¸‰èƒ½å¤Ÿåƒä¸Šéº»è¾£çƒ«ï¼Œæˆ‘ä»¬å¯ä»¥å¸®åŠ©æå››èµšé’±â€”â€”è®©ç‹äºŒè¿‡æ¥è¿›è¡ŒçŸ¥è¯†ä»˜è´¹ã€‚

### [5.4è¿è¡Œç‹äºŒè¿‡æ¥çŸ¥è¯†ä»˜è´¹](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_54è¿è¡Œç‹äºŒè¿‡æ¥çŸ¥è¯†ä»˜è´¹)

åŒæ ·çš„å†åˆ‡åˆ†å‡ºä¸€ä¸ªç»ˆç«¯ï¼Œç„¶åsourceè¿è¡Œç‹äºŒèŠ‚ç‚¹ã€‚

```
source install/setup.bash
ros2 run village_wang wang2_node 
```

é‡æ–°è¿è¡Œæä¸‰èŠ‚ç‚¹ï¼Œç‚¹å‡»æä¸‰è¿è¡Œçš„ç»ˆç«¯ï¼Œå…ˆè¾“å…¥`Ctrl+C`ä½¿å…¶é€€å‡ºï¼Œå†é‡æ–°è¿è¡ŒèŠ‚ç‚¹ã€‚

```
ros2 run village_li li3_node
```

![image-20210817110416711](https://fishros.com/d2lros2foxy/chapt4/4.9æœåŠ¡å®ç°(Python)/imgs/image-20210817110416711.png)

å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶æå››è´¦æˆ·é‡Œå·²ç»æœ‰äº†å…­ç™¾å¤šå—äº†ï¼Œå¾ˆè½»æ¾çš„å€Ÿç»™äº†æä¸‰10å—é’±ï¼Œè¿™å¤šäºäº†ç‹äºŒçš„çŸ¥è¯†ä»˜è´¹ã€‚

## [6.ç»“æŸ](https://fishros.com/d2lros2foxy/#/chapt4/4.9æœåŠ¡å®ç°(Python)?id=_6ç»“æŸ)

è‡³æ­¤ï¼Œæˆ‘ä»¬å¸®åŠ©æä¸‰æˆåŠŸå€Ÿé’±ï¼Œåƒä¸Šäº†éº»è¾£çƒ«ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ç¼–å†™C++ç¨‹åºï¼ŒåŠªåŠ›å¸®åŠ©å¼ ä¸‰çœ‹ä¸ŠäºŒæ‰‹ä¹¦ã€‚

å¦‚æœè¿˜æœ‰ä¸æ˜ç™½çš„åœ°æ–¹ï¼Œæ¬¢è¿åŠ å…¥é±¼ç¾¤äº¤æµã€‚

# [4.5.3 C++æœåŠ¡é€šä¿¡å®ç°(å¼ ä¸‰ä¹°ä¹¦)](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_453-cæœåŠ¡é€šä¿¡å®ç°å¼ ä¸‰ä¹°ä¹¦)

çœ‹åˆ°å¼ ä¸‰ä¹°ä¹¦å°±çªç„¶æƒ³èµ·`åå¼ºä¹°ç“œ`ï¼Œä½†å¼ ä¸‰æ˜¯çœŸå¿ƒä¹°ä¹¦ä¸æ˜¯å­˜å¿ƒæ‰¾èŒ¬ã€‚å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¢³ç†ä¸€ä¸‹ä¹°ä¹¦ä»»åŠ¡æµç¨‹ã€‚

## [1.ä»»åŠ¡æµç¨‹](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_1ä»»åŠ¡æµç¨‹)

**ä¸€å¥è¯ï¼šå¼ ä¸‰æ‹¿å¤šå°‘é’±é’±ç»™ç‹äºŒï¼Œç‹äºŒå‡‘å¤Ÿå¤šå°‘ä¸ªç« èŠ‚çš„è‰³å¨˜ä¼ å¥‡ç»™ä»–**

## [2.æœåŠ¡ç«¯ï¼ˆç‹äºŒï¼‰å®ç°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_2æœåŠ¡ç«¯ï¼ˆç‹äºŒï¼‰å®ç°)

é¦–å…ˆæ˜¯ä½œä¸ºäºŒæ‰‹ä¹¦æä¾›è€…çš„æœåŠ¡ç«¯ç‹äºŒèŠ‚ç‚¹ä»£ç çš„ç¼–å†™ã€‚

### [2.1 åˆ›å»ºC++æœåŠ¡é€šä¿¡æœåŠ¡ç«¯çš„æ­¥éª¤](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_21-åˆ›å»ºcæœåŠ¡é€šä¿¡æœåŠ¡ç«¯çš„æ­¥éª¤)

1. å¯¼å…¥æœåŠ¡æ¥å£
2. åˆ›å»ºæœåŠ¡ç«¯å›è°ƒå‡½æ•°
3. å£°æ˜å¹¶åˆ›å»ºæœåŠ¡ç«¯
4. ç¼–å†™å›è°ƒå‡½æ•°é€»è¾‘å¤„ç†è¯·æ±‚

### [2.2 æ·»åŠ æœåŠ¡æ¥å£ä¸ä¾èµ–](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_22-æ·»åŠ æœåŠ¡æ¥å£ä¸ä¾èµ–)

#### [2.2.1 æ·»åŠ ä¾èµ–](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_221-æ·»åŠ ä¾èµ–)

> æ·»åŠ ä¾èµ–æ˜¯ä¸ºäº†è®©ç¨‹åºèƒ½å¤Ÿåœ¨ç¼–è¯‘å’Œè¿è¡Œæ—¶æ‰¾åˆ°å¯¹åº”çš„æ¥å£

å› ä¸º`village_wang`çš„åŒ…ç±»å‹æ˜¯`ament_cmake`ï¼Œæ•…éœ€è¦è¿›è¡Œä»¥ä¸‹ä¸¤æ­¥æ“ä½œï¼š

**ç¬¬ä¸€æ­¥ä¿®æ”¹`package.xml`**

åŠ å…¥ä¸‹é¢çš„ä»£ç ï¼ˆå‘Šè¯‰colconï¼Œç¼–è¯‘ä¹‹å‰è¦ç¡®ä¿æœ‰village_interfaceså­˜åœ¨ï¼‰

```xml
  <depend>village_interfaces</depend>
```

![image-20210816153438400](assets/image-20210816153438400-17675056959832.png)

**ç¬¬äºŒæ­¥ä¿®æ”¹å’Œ`CMakeLists.txt`**

åœ¨`CMakeLists.txt`ä¸­åŠ å…¥ä¸‹é¢ä¸€è¡Œä»£ç 

```cmake
find_package(village_interfaces REQUIRED)
```

> find_packageæ˜¯cmakeçš„è¯­æ³•ï¼Œç”¨äºæŸ¥æ‰¾åº“ã€‚æ‰¾åˆ°åï¼Œè¿˜éœ€è¦å°†å…¶å’Œå¯æ‰§è¡Œæ–‡ä»¶é“¾æ¥èµ·æ¥

æ‰€ä»¥è¿˜éœ€è¦ä¿®æ”¹`ament_target_dependencies`ï¼Œåœ¨å…¶ä¸­æ·»åŠ `village_interfaces`ã€‚

```cmake
ament_target_dependencies(wang2_node 
  rclcpp 
  village_interfaces
)
```

#### [2.2.2 æ·»åŠ æœåŠ¡æ¥å£](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_222-æ·»åŠ æœåŠ¡æ¥å£)

å¯¹äºC++æ¥è¯´ï¼Œæ·»åŠ æœåŠ¡æ¥å£åªéœ€åœ¨ç¨‹åºä¸­å¼•å…¥å¯¹åº”çš„å¤´æ–‡ä»¶å³å¯ã€‚

> è¿™ä¸ªå¤´æ–‡ä»¶å°±æ˜¯æˆ‘ä»¬`SellNovel.srv`ç”Ÿæˆçš„å¤´æ–‡ä»¶

```c++
#include "village_interfaces/srv/sell_novel.hpp"
```

### [2.3 å£°æ˜å›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_23-å£°æ˜å›è°ƒå‡½æ•°)

#### [2.3.1 å£°æ˜å›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_231-å£°æ˜å›è°ƒå‡½æ•°)

æ·»åŠ å®ŒæœåŠ¡æ¥å£æ¥ç€å°±å¯ä»¥å£°æ˜ä¸€ä¸ª**å–ä¹¦è¯·æ±‚å›è°ƒå‡½æ•°**ã€‚

```c++
// å£°æ˜ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“æ”¶åˆ°ä¹°ä¹¦è¯·æ±‚æ—¶è°ƒç”¨è¯¥å‡½æ•°ï¼Œç”¨äºå¤„ç†æ•°æ®
void sell_book_callback(const village_interfaces::srv::SellNovel::Request::SharedPtr request,
        const village_interfaces::srv::SellNovel::Response::SharedPtr response)
{
}
```

#### [2.3.2 å­˜ä¹¦çš„é˜Ÿåˆ—ï¼ˆå¯ä»¥ç†è§£ä¸ºä¹¦åº“ï¼‰](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_232-å­˜ä¹¦çš„é˜Ÿåˆ—ï¼ˆå¯ä»¥ç†è§£ä¸ºä¹¦åº“ï¼‰)

å†åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾è‡ªå·±çœ‹è¿‡çš„äºŒæ‰‹ä¹¦ï¼Œåˆ›å»ºé˜Ÿåˆ—éœ€è¦ç”¨åˆ°queueå®¹å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆç”¨`#include <queue>`åœ¨ç¨‹åºå¼€å¤´å¼•å…¥è¯¥å®¹å™¨ï¼Œå†åœ¨ä»£ç ä¸­æ·»åŠ ä¸‹é¢è¿™å¥è¯ã€‚

```c++
//åˆ›å»ºä¸€ä¸ªå°è¯´ç« èŠ‚é˜Ÿåˆ—
std::queue<std::string>  novels_queue;
```

#### [2.3.3 æ­»é”](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_233-æ­»é”)

å½“å¼ ä¸‰è¯·æ±‚ç‹äºŒä¹°äºŒæ‰‹ä¹¦çš„æ—¶å€™ï¼Œå‡å¦‚ç‹äºŒæ‰‹é‡Œä¹¦çš„æ•°é‡ä¸è¶³ï¼Œç‹äºŒå°±ç­‰æ”’å¤Ÿäº†å¯¹åº”æ•°é‡çš„ä¹¦å†è¿”å›ç»™å¼ ä¸‰ã€‚

ç­‰å¾…æ”’å¤Ÿç« èŠ‚çš„æ“ä½œéœ€è¦åœ¨`å–ä¹¦æœåŠ¡å‡½æ•°`ä¸­é˜»å¡å½“å‰çº¿ç¨‹ï¼Œé˜»å¡åç‹äºŒå°±æ”¶ä¸åˆ°æå››å†™çš„å°è¯´äº†ï¼Œè¿™æ ·ä¸€æ¥å°±ä¼šé€ æˆä¸€ä¸ªå¾ˆå°´å°¬çš„æƒ…æ™¯ï¼š

**åœ¨å–ä¹¦æœåŠ¡å›è°ƒå‡½æ•°ä¸­ç­‰ç€ä¹¦åº“ï¼ˆé˜Ÿåˆ—ï¼‰é‡Œå°è¯´ç« èŠ‚æ•°é‡æ»¡è¶³å¼ ä¸‰éœ€æ±‚ï¼Œæ¥æ”¶å°è¯´çš„ç¨‹åºç­‰ç€è¿™è¾¹çš„å–ä¹¦å›è°ƒå‡½æ•°ç»“æŸï¼Œå¥½æŠŠä¹¦æ”¾è¿›ä¹¦åº“ï¼ˆé˜Ÿåˆ—ï¼‰é‡Œã€‚**

è¿™ç§äº’ç›¸ç­‰å¾…çš„æƒ…å†µï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ­»é”ã€‚é‚£å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

#### [2.3.4 å¤šçº¿ç¨‹](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_234-å¤šçº¿ç¨‹)

å¤§å®¶å¯èƒ½ä¼šé—®ï¼Œä¸ºå•¥æ¥æ”¶å°è¯´çš„ç¨‹åºä¸èƒ½è‡ªå·±å•ç‹¬å¹²ï¼Œéè¦ç­‰å¾…æœåŠ¡å›è°ƒå‡½æ•°ç»“æŸæ‰æŠŠä¹¦æ”¾åˆ°ä¹¦åº“ï¼Œä¸èƒ½æ”¶åˆ°ä¹¦å°±æŠŠä¹¦ç›´æ¥æ”¾åˆ°ä¹¦åº“å—ï¼Ÿ

åŸå› æ˜¯ROS2é»˜è®¤æ˜¯å•çº¿ç¨‹çš„ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è·‘ï¼Œå¤§å®¶éƒ½æ˜¯é¡ºåºæ‰§è¡Œï¼Œä½ å¹²å®Œæˆ‘å¹²ï¼Œä¸€æ¡çº¿ä¸‹å»ã€‚

æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå³æ¯æ¬¡æ”¶åˆ°æœåŠ¡è¯·æ±‚åï¼Œå•ç‹¬å¼€ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œä¸å½±å“å…¶ä»–éƒ¨åˆ†ã€‚

#### [2.3.5 å›è°ƒå‡½æ•°ç»„](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_235-å›è°ƒå‡½æ•°ç»„)

ROS2ä¸­è¦ä½¿ç”¨å¤šçº¿ç¨‹æ‰§è¡Œå™¨å’Œå›è°ƒç»„æ¥å®ç°å¤šçº¿ç¨‹ï¼Œæˆ‘ä»¬å…ˆåœ¨`SingleDogNode`ä¸­å£°æ˜ä¸€ä¸ªå›è°ƒç»„æˆå‘˜å˜é‡ã€‚

```c++
// å£°æ˜ä¸€ä¸ªæœåŠ¡å›è°ƒç»„
rclcpp::CallbackGroup::SharedPtr callback_group_service_;
```

å®Œæˆ å£°æ˜ä¹‹åï¼Œæˆ‘ä»¬çš„`SingleDogNode`æ–°å¢å†…å®¹å¦‚ä¸‹ï¼š

#### [2.3.6 æœ€ç»ˆç»“æœ](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_236-æœ€ç»ˆç»“æœ)

```c++
class SingleDogNode : public rclcpp::Node 
{

public:
    // æ„é€ å‡½æ•°
    SingleDogNode(std::string name) : Node(name)
    {
    }
    
private:
    // å£°æ˜ä¸€ä¸ªæœåŠ¡å›è°ƒç»„
    rclcpp::CallbackGroup::SharedPtr callback_group_service_;
    //åˆ›å»ºä¸€ä¸ªå°è¯´ç« èŠ‚é˜Ÿåˆ—
    std::queue<std::string>  novels_queue;
    // å£°æ˜ä¸€ä¸ªæœåŠ¡ç«¯
    rclcpp::Service<village_interfaces::srv::SellNovel>::SharedPtr server_;
    // å£°æ˜ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“æ”¶åˆ°ä¹°ä¹¦è¯·æ±‚æ—¶è°ƒç”¨è¯¥å‡½æ•°ï¼Œç”¨äºå¤„ç†æ•°æ®
    void sell_book_callback(const village_interfaces::srv::SellNovel::Request::SharedPtr request,
        const village_interfaces::srv::SellNovel::Response::SharedPtr response)
    {
        //å¯¹è¯·æ±‚æ•°æ®è¿›è¡Œå¤„ç†
    }
};
```

### [2.4 å®ä¾‹åŒ–æœåŠ¡ç«¯å¹¶ç¼–å†™å›è°ƒå‡½æ•°å¤„ç†è¯·æ±‚](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_24-å®ä¾‹åŒ–æœåŠ¡ç«¯å¹¶ç¼–å†™å›è°ƒå‡½æ•°å¤„ç†è¯·æ±‚)

#### [2.4.1 å®ä¾‹åŒ–å›è°ƒç»„](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_241-å®ä¾‹åŒ–å›è°ƒç»„)

åœ¨`ROS2`ä¸­ï¼Œå›è°ƒå‡½æ•°ç»„ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé€šè¿‡å®ä¾‹åŒ–`create_callback_group`ç±»å³å¯åˆ›å»ºä¸€ä¸ªcallback_group_serviceçš„å¯¹è±¡ã€‚

åœ¨SingleDogNodeçš„æ„é€ å‡½æ•°ä¸­æ·»åŠ ä¸‹é¢è¿™è¡Œä»£ç ï¼Œå³å¯å®Œæˆå®ä¾‹åŒ–

```
callback_group_service_ = this->create_callback_group(rclcpp::CallbackGroupType::MutuallyExclusive);
```

#### [2.4.2 å£°æ˜å¹¶å®ä¾‹åŒ–æœåŠ¡ç«¯](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_242-å£°æ˜å¹¶å®ä¾‹åŒ–æœåŠ¡ç«¯)

æˆ‘ä»¬ä½¿ç”¨æˆå‘˜å‡½æ•°ä½œä¸ºå›è°ƒå‡½æ•°ï¼Œè¿™é‡Œè¦æ ¹æ®å›è°ƒå‡½æ•°ä¸­å‚æ•°ä¸ªæ•°ï¼Œè®¾ç½®å ä½ç¬¦ï¼Œå³å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦ä¼ å…¥çš„å‚æ•°ä¸ªæ•°ã€‚

> åœ¨ä¹‹å‰è®¢é˜…è¯é¢˜çš„å›è°ƒå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å·²ç»ç”¨åˆ°è¿‡ä¸€æ¬¡äº†ï¼Œå› ä¸ºè¯é¢˜å›è°ƒåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥åªéœ€è¦ä¸€ä¸ªå ä½ç¬¦ï¼Œè¿™é‡ŒæœåŠ¡çš„å›è°ƒæ˜¯ä¸¤ä¸ªå‚æ•°ï¼Œæ‰€ä»¥è¦è®¾ç½®ä¸¤ä¸ª

```c++
using std::placeholders::_1;
using std::placeholders::_2;
```

åœ¨`private:`ä¸‹**å£°æ˜æœåŠ¡ç«¯**

```
// å£°æ˜ä¸€ä¸ªæœåŠ¡ç«¯
rclcpp::Service<village_interfaces::srv::SellNovel>::SharedPtr server_;
```

åœ¨æ„é€ å‡½æ•°ä¸­**å®ä¾‹åŒ–æœåŠ¡ç«¯**

```C++
// å®ä¾‹åŒ–å–äºŒæ‰‹ä¹¦çš„æœåŠ¡
server_ = this->create_service<village_interfaces::srv::SellNovel>("sell_novel",
                            std::bind(&SingleDogNode::sell_book_callback,this,_1,_2),
                            rmw_qos_profile_services_default,
                            callback_group_service_);
```

å®ä¾‹åŒ–æœåŠ¡ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨`create_service`å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªæ¨¡ç‰ˆå‡½æ•°ï¼Œéœ€è¦è¾“å…¥è¦åˆ›å»ºçš„æœåŠ¡ç±»å‹ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯`<village_interfaces::srv::SellNovel>`ï¼Œè¿™ä¸ªå‡½æ•°æœ‰å››ä¸ªå‚æ•°éœ€è¦è¾“å…¥,å°é±¼æ¥ä¸‹æ¥è¿›è¡Œä¸€ä¸€ä»‹ç»

- `"sell_novel"`æœåŠ¡åç§°ï¼Œæ²¡å•¥å¥½è¯´çš„ï¼Œè¦å”¯ä¸€å“¦ï¼Œå› ä¸ºæœåŠ¡åªèƒ½æœ‰ä¸€ä¸ª
- `std::bind(&SingleDogNode::sell_book_callback,this,_1,_2)`å›è°ƒå‡½æ•°ï¼Œè¿™é‡ŒæŒ‡å‘äº†æˆ‘ä»¬2.3.1ä¸­æˆ‘ä»¬å£°æ˜çš„`sell_book_callback`
- `rmw_qos_profile_services_default` é€šä¿¡è´¨é‡ï¼Œè¿™é‡Œä½¿ç”¨æœåŠ¡é»˜è®¤çš„é€šä¿¡è´¨é‡
- `callback_group_service_`ï¼Œå›è°ƒç»„ï¼Œæˆ‘ä»¬å‰é¢åˆ›å»ºå›è°ƒç»„å°±æ˜¯åœ¨è¿™é‡Œä½¿ç”¨çš„ï¼Œå‘Šè¯‰ROS2ï¼Œå½“ä½ è¦è°ƒç”¨å›è°ƒå‡½æ•°å¤„ç†è¯·æ±‚æ—¶ï¼Œè¯·æŠŠå®ƒæ”¾åˆ°å•ç‹¬çº¿ç¨‹çš„å›è°ƒç»„ä¸­

#### [2.4.4  ç¼–å†™å›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_244-ç¼–å†™å›è°ƒå‡½æ•°)

ç°åœ¨æˆ‘ä»¬å¼€å§‹ç¼–å†™å›è°ƒå‡½æ•°ï¼Œè¿™é‡Œå±äºé‡ç‚¹éƒ¨åˆ†ã€‚å…ˆæŠŠæ•´ä¸ªä»£ç æ”¾ä¸€ä¸‹ã€‚

```c++
    // å£°æ˜ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“æ”¶åˆ°ä¹°ä¹¦è¯·æ±‚æ—¶è°ƒç”¨è¯¥å‡½æ•°ï¼Œç”¨äºå¤„ç†æ•°æ®
    void sell_book_callback(const village_interfaces::srv::SellNovel::Request::SharedPtr request,
        const village_interfaces::srv::SellNovel::Response::SharedPtr response)
    {
        RCLCPP_INFO(this->get_logger(), "æ”¶åˆ°ä¸€ä¸ªä¹°ä¹¦è¯·æ±‚ï¼Œä¸€å…±ç»™äº†%dé’±",request->money);
        unsigned int novelsNum = request->money*1;  //åº”ç»™å°è¯´æ•°é‡ï¼Œä¸€å—é’±ä¸€ç« 

        //åˆ¤æ–­å½“å‰ä¹¦åº“é‡Œä¹¦çš„æ•°é‡æ˜¯å¦æ»¡è¶³å¼ ä¸‰è¦ä¹°çš„æ•°é‡ï¼Œä¸å¤Ÿåˆ™è¿›å…¥ç­‰å¾…å‡½æ•°
        if(novels_queue.size()<novelsNum)
        {
            RCLCPP_INFO(this->get_logger(), "å½“å‰è‰³å¨˜ä¼ å¥‡ç« èŠ‚å­˜é‡ä¸º%dï¼šä¸èƒ½æ»¡è¶³éœ€æ±‚,å¼€å§‹ç­‰å¾…",novels_queue.size());

            // è®¾ç½®rateå‘¨æœŸä¸º1sï¼Œä»£è¡¨1sæ£€æŸ¥ä¸€æ¬¡
            rclcpp::Rate loop_rate(1);

            //å½“ä¹¦åº“é‡Œå°è¯´æ•°é‡å°äºè¯·æ±‚æ•°é‡æ—¶ä¸€ç›´å¾ªç¯
            while (novels_queue.size()<novelsNum)
            {
                //åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦è¿˜åœ¨è¿è¡Œ
                if(!rclcpp::ok())
                {
                    RCLCPP_ERROR(this->get_logger(), "ç¨‹åºè¢«ç»ˆæ­¢äº†");
                    return ;
                }
                //æ‰“å°ä¸€ä¸‹å½“å‰çš„ç« èŠ‚æ•°é‡å’Œç¼ºå°‘çš„æ•°é‡
                RCLCPP_INFO(this->get_logger(), "ç­‰å¾…ä¸­ï¼Œç›®å‰å·²æœ‰%dç« ï¼Œè¿˜å·®%dç« ",novels_queue.size(),novelsNum-novels_queue.size());

                //rate.sleep()è®©æ•´ä¸ªå¾ªç¯1sè¿è¡Œä¸€æ¬¡
                loop_rate.sleep();
            }
        }
        // ç« èŠ‚æ•°é‡æ»¡è¶³éœ€æ±‚äº†
        RCLCPP_INFO(this->get_logger(), "å½“å‰è‰³å¨˜ä¼ å¥‡ç« èŠ‚å­˜é‡ä¸º%dï¼šå·²ç»æ»¡è¶³éœ€æ±‚",novels_queue.size());

        //ä¸€æœ¬æœ¬æŠŠä¹¦å–å‡ºæ¥ï¼Œæ”¾è¿›è¯·æ±‚å“åº”å¯¹è±¡responseä¸­
        for(unsigned int i =0 ;i<novelsNum;i++)
        {
            response->novels.push_back(novels_queue.front());
            novels_queue.pop();
        }
    }
```

å½“æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå…ˆè®¡ç®—ä¸€ä¸‹åº”è¯¥ç»™å¼ ä¸‰å¤šå°‘ä¹¦`novelsNum`ï¼Œç„¶ååˆ¤æ–­ä¹¦åº“é‡Œä¹¦çš„æ•°é‡å¤Ÿä¸å¤Ÿï¼Œä¸å¤Ÿåˆ™è¿›å…¥æ”’ä¹¦ç¨‹åºã€‚å¦‚æœå¤Ÿæˆ–è€…æ”’å¤Ÿäº†å°±æŠŠä¹¦æ”¾åˆ°æœåŠ¡å“åº”å¯¹è±¡é‡Œï¼Œè¿”å›ç»™å¼ ä¸‰ã€‚

ä½ å¯èƒ½æœ‰ä¸€äº›ç–‘é—®ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å†™æŠŠä¹¦æ”¾è¿›ä¹¦åº“ï¼ˆé˜Ÿåˆ—`novels_queue`ï¼‰çš„ç¨‹åºå‘€ï¼Œæ˜¯çš„ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ä¸€ä¸‹è¯é¢˜å›è°ƒå‡½æ•°ï¼Œå¢åŠ äº†ä¸€è¡Œä»£ç ï¼Œå°†å°è¯´æ”¾åˆ°ä¹¦åº“é‡Œ`novels_queue.push(msg->data);`

```
 // æ”¶åˆ°è¯é¢˜æ•°æ®çš„å›è°ƒå‡½æ•°
 void topic_callback(const std_msgs::msg::String::SharedPtr msg){
     // æ–°å»ºä¸€å¼ äººæ°‘å¸
     std_msgs::msg::UInt32 money;
     money.data = 10;

    // å‘é€äººæ°‘å¸ç»™æå››
    pub_->publish(money);
    RCLCPP_INFO(this->get_logger(), "ç‹äºŒï¼šæˆ‘æ”¶åˆ°äº†ï¼š'%s' ï¼Œå¹¶ç»™äº†æå››ï¼š%d å…ƒçš„ç¨¿è´¹", msg->data.c_str(),money.data);

    //å°†å°è¯´æ”¾å…¥novels_queueä¸­
    novels_queue.push(msg->data);
};
```

### [2.5 ä¿®æ”¹`main`å‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_25-ä¿®æ”¹mainå‡½æ•°)

å› ä¸ºæˆ‘ä»¬è¦è®©æ•´ä¸ªç¨‹åºå˜æˆå¤šçº¿ç¨‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠèŠ‚ç‚¹çš„æ‰§è¡Œå™¨å˜æˆå¤šçº¿ç¨‹æ‰§è¡Œå™¨ã€‚

ä¿®æ”¹ä¸€ä¸‹`main`å‡½æ•°ï¼Œæ–°å»ºä¸€ä¸ªå¤šçº¿ç¨‹æ‰§è¡Œå™¨ï¼Œæ·»åŠ ç‹äºŒèŠ‚ç‚¹å¹¶`spin`,å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```
int main(int argc, char **argv)
{
    rclcpp::init(argc, argv);
    /*äº§ç”Ÿä¸€ä¸ªWang2çš„èŠ‚ç‚¹*/
    auto node = std::make_shared<SingleDogNode>("wang2");
    /* è¿è¡ŒèŠ‚ç‚¹ï¼Œå¹¶æ£€æµ‹é€€å‡ºä¿¡å·*/
    rclcpp::executors::MultiThreadedExecutor exector;
    exector.add_node(node);
    exector.spin();
    rclcpp::shutdown();
    return 0;
}
```

ç‹äºŒèŠ‚ç‚¹å®Œæ•´ä»£ç è§ï¼š[wang2.cpp](https://raw.githubusercontent.com/fishros/ros2_town/af8b29f7b23153d35348ebfcd3b1bc5760c6c5a6/village_wang/src/wang2.cpp)

### [2.6 ç¼–è¯‘](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_26-ç¼–è¯‘)

åœ¨å·¥ä½œç©ºé—´ä¸‹ï¼šè¾“å…¥ä¸‹é¢çš„æŒ‡ä»¤

```
colcon build --packages-select village_wang
```

![image-20210825173336167](https://fishros.com/d2lros2foxy/chapt4/4.10æœåŠ¡å®ç°(C++)/imgs/image-20210825173336167.png)

### [2.7 è¿è¡Œæµ‹è¯•](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_27-è¿è¡Œæµ‹è¯•)

#### [2.7.1 sourceç¯å¢ƒ](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_271-sourceç¯å¢ƒ)

æ‰“å¼€vscodeç»ˆç«¯ï¼Œè¾“å…¥

```shell
source install/setup.bash
```

#### [2.7.2 è¿è¡Œç‹äºŒèŠ‚ç‚¹](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_272-è¿è¡Œç‹äºŒèŠ‚ç‚¹)

```
ros2 run village_wang wang2_node
```

#### [2.7.3 ä½¿ç”¨å‘½ä»¤è¡Œå‘é€ä¹°ä¹¦è¯·æ±‚](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_273-ä½¿ç”¨å‘½ä»¤è¡Œå‘é€ä¹°ä¹¦è¯·æ±‚)

åˆ‡åˆ†ä¸€ä¸ªç»ˆç«¯ï¼Œsource

```shell
source install/setup.bash
```

æŸ¥çœ‹ä¸€ä¸‹æœåŠ¡åˆ—è¡¨

```shell
ros2@ubuntu:~/code/town_ws$ ros2 service list -t
/sell_book [village_interfaces/srv/SellNovel]
```

æ‰‹åŠ¨å‘é€ä¹°ä¹¦è¯·æ±‚

```shell
ros2 service call /sell_book  village_interfaces/srv/SellNovel "{money: 5}"
```

![image-20210831115903946](https://fishros.com/d2lros2foxy/chapt4/4.10æœåŠ¡å®ç°(C++)/imgs/image-20210831115903946.png)

#### [2.7.4 å¯åŠ¨æå››å†™ä¹¦](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_274-å¯åŠ¨æå››å†™ä¹¦)

è§‚å¯Ÿä»¥ä¸Šç»“æœå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä¹°åˆ°ä¹¦ï¼Œå› ä¸ºç‹äºŒè¿™é‡Œä¹Ÿæ²¡æœ‰ï¼Œè¿™æ—¶å€™å°±éœ€è¦æˆ‘ä»¬æ¥å¯åŠ¨æå››èŠ‚ç‚¹æ¥å†™ä¹¦äº†ã€‚

å†åˆ‡åˆ†ä¸€ä¸ªç»ˆç«¯å‡ºæ¥ï¼š

```shell
source install/setup.bash
```

å¯åŠ¨æå››å†™ä¹¦

```shell
ros2 run village_li li4_node
```

#### [2.7.5 ç»“æœå±•ç¤º](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_275-ç»“æœå±•ç¤º)

![image-20210831124712850](https://fishros.com/d2lros2foxy/chapt4/4.10æœåŠ¡å®ç°(C++)/imgs/image-20210831124712850.png)

## [3.å®¢æˆ·ç«¯ï¼ˆå¼ ä¸‰ï¼‰å®ç°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_3å®¢æˆ·ç«¯ï¼ˆå¼ ä¸‰ï¼‰å®ç°)

ç¼–å†™å®ŒæœåŠ¡ç«¯çš„ç¨‹åºï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™å®¢æˆ·ç«¯å¼ ä¸‰äº†ã€‚

### [3.1 ç¼–å†™ROS2æœåŠ¡é€šä¿¡å®¢æˆ·ç«¯æ­¥éª¤](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_31-ç¼–å†™ros2æœåŠ¡é€šä¿¡å®¢æˆ·ç«¯æ­¥éª¤)

1. å¯¼å…¥æœåŠ¡æ¥å£
2. åˆ›å»ºè¯·æ±‚ç»“æœæ¥æ”¶å›è°ƒå‡½æ•°
3. å£°æ˜å¹¶åˆ›å»ºå®¢æˆ·ç«¯
4. ç¼–å†™ç»“æœæ¥æ”¶é€»è¾‘
5. è°ƒç”¨å®¢æˆ·ç«¯å‘é€è¯·æ±‚

### [3.2 æ·»åŠ æœåŠ¡æ¥å£ä¸ä¾èµ–](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_32-æ·»åŠ æœåŠ¡æ¥å£ä¸ä¾èµ–)

#### [3.2.1 åˆ›å»ºå®¢æˆ·ç«¯èŠ‚ç‚¹](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_321-åˆ›å»ºå®¢æˆ·ç«¯èŠ‚ç‚¹)

å› ä¸ºå¼ å®¶æ‘å’Œå¼ ä¸‰ä¹‹å‰ä¸å­˜åœ¨ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ–°åˆ›å»ºå‡ºæ¥ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

æ‰“å¼€ç»ˆç«¯åˆ°srcæ–‡ä»¶å¤¹ä¸‹ï¼š

```
ros2 pkg create village_zhang --build-type ament_cmake --dependencies rclcpp
```

ç„¶ååœ¨`src/village_zhang/src`ç›®å½•ä¸‹æ–°å»º`zhang3.cpp`

å®Œæˆåç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

![image-20210831125824511](https://fishros.com/d2lros2foxy/chapt4/4.10æœåŠ¡å®ç°(C++)/imgs/image-20210831125824511.png)

#### [3.2.2 åˆ›å»ºå®¢æˆ·ç«¯èŠ‚ç‚¹](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_322-åˆ›å»ºå®¢æˆ·ç«¯èŠ‚ç‚¹)

å› ä¸ºå¼ ä¸‰è¦æ‰¾ç‹äºŒè¯·æ±‚å°è¯´ï¼Œæ‰€ä»¥ä¸€å®šä¾èµ–é€šä¿¡æ¥å£`village_interfaces`

> æ·»åŠ ä¾èµ–æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©ç¨‹åºåœ¨ç¼–è¯‘å’Œè¿è¡Œæ—¶æ‰¾åˆ°å¯¹åº”çš„æ¥å£

å› ä¸º`village_zhang`æ˜¯åŒ…ç±»å‹æ˜¯`ament_cmake`ï¼Œä¸ä¸Šé¢ä¸€æ ·éœ€è¦ä¸¤æ­¥æ“ä½œ.

**ç¬¬ä¸€æ­¥ä¿®æ”¹`package.xml`**

åŠ å…¥ä¸‹é¢çš„ä»£ç ï¼ˆå‘Šè¯‰colconï¼Œç¼–è¯‘ä¹‹å‰è¦ç¡®ä¿æœ‰village_interfaceså­˜åœ¨ï¼‰

```xml
  <depend>village_interfaces</depend>
```

![image-20210831130256663](https://fishros.com/d2lros2foxy/chapt4/4.10æœåŠ¡å®ç°(C++)/imgs/image-20210831130256663.png)

**ç¬¬äºŒæ­¥ä¿®æ”¹å’Œ`CMakeLists.txt`**

åœ¨`CMakeLists.txt`ä¸­åŠ å…¥ä¸‹é¢ä¸€è¡Œä»£ç 

```cmake
find_package(village_interfaces REQUIRED)
```

> find_packageæ˜¯cmakeçš„è¯­æ³•ï¼Œç”¨äºæŸ¥æ‰¾åº“ã€‚æ‰¾åˆ°åï¼Œè¿˜éœ€è¦å°†å…¶å’Œå¯æ‰§è¡Œæ–‡ä»¶é“¾æ¥èµ·æ¥

æ¥ç€æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶

```
add_executable(zhang3_node src/zhang3.cpp)
```

ä¸Šé¢æ‰¾åˆ°åº“ä¹‹åï¼Œå°†å…¶ä¸å¯æ‰§è¡Œæ–‡ä»¶é“¾æ¥èµ·æ¥ï¼Œè¿˜éœ€è¦ä¿®æ”¹`ament_target_dependencies`ï¼Œåœ¨å…¶ä¸­æ·»åŠ `rclcpp å’Œ village_interfaces`ã€‚

```cmake
ament_target_dependencies(zhang3_node
  rclcpp 
  village_interfaces
)
```

### [3.3 åˆ›å»ºå¼ ä¸‰èŠ‚ç‚¹ã€æœåŠ¡å®¢æˆ·ç«¯ã€è¯·æ±‚å‡½æ•°å’Œè¯·æ±‚ç»“æœå›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_33-åˆ›å»ºå¼ ä¸‰èŠ‚ç‚¹ã€æœåŠ¡å®¢æˆ·ç«¯ã€è¯·æ±‚å‡½æ•°å’Œè¯·æ±‚ç»“æœå›è°ƒå‡½æ•°)

#### [3.3.1 åˆ›å»ºå®¢æˆ·ç«¯](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_331-åˆ›å»ºå®¢æˆ·ç«¯)

æ¥ç€æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™å®¢æˆ·ç«¯äº†ï¼Œç©·å…‰è›‹å¼ ä¸‰ä¹Ÿæ˜¯C++ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒç‹äºŒçš„ä»£ç ï¼Œå»ºç«‹ä¸€ä¸ªC++èŠ‚ç‚¹çš„åŸºæœ¬çš„æ¡†æ¶ã€‚

```c++
#include "rclcpp/rclcpp.hpp"
#include "village_interfaces/srv/sell_novel.hpp"

// æå‰å£°æ˜çš„å ä½ç¬¦ï¼Œç•™ç€åˆ›å»ºå®¢æˆ·ç«¯çš„æ—¶å€™ç”¨
using std::placeholders::_1;

/*
    åˆ›å»ºä¸€ä¸ªç±»èŠ‚ç‚¹ï¼Œåå­—å«åšPoorManNode,ç»§æ‰¿è‡ªNode.
*/
class PoorManNode : public rclcpp::Node
{

public:
    /* æ„é€ å‡½æ•° */
    PoorManNode(std::string name) : Node(name)
    {
        // æ‰“å°ä¸€å¥è‡ªæˆ‘ä»‹ç»
        RCLCPP_INFO(this->get_logger(), "å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¾—äº†ç©·ç—…çš„å¼ ä¸‰.");
    }
private:
};

/*ä¸»å‡½æ•°*/
int main(int argc, char **argv)
{
    rclcpp::init(argc, argv);
    /*äº§ç”Ÿä¸€ä¸ªZhang3çš„èŠ‚ç‚¹*/
    auto node = std::make_shared<PoorManNode>("zhang3");
    /* è¿è¡ŒèŠ‚ç‚¹ï¼Œå¹¶æ£€æµ‹rclcppçŠ¶æ€*/
    rclcpp::spin(node);
    rclcpp::shutdown();
    return 0;
}
```

#### [3.3.2 å£°æ˜å®¢æˆ·ç«¯](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_332-å£°æ˜å®¢æˆ·ç«¯)

è¿™é‡Œåªæ˜¯å£°æ˜å®¢æˆ·ç«¯ï¼Œå¹¶æŒ‡æ˜è¿™ä¸ªå®¢æˆ·ç«¯çš„ç±»å‹æ˜¯`village_interfaces::srv::SellNovel`

```c++
    // åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯
    rclcpp::Client<village_interfaces::srv::SellNovel>::SharedPtr client_;
```

#### [3.3.3 åˆ›å»ºè¯·æ±‚å‡½æ•°å’Œå›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_333-åˆ›å»ºè¯·æ±‚å‡½æ•°å’Œå›è°ƒå‡½æ•°)

åœ¨classé‡Œçš„publicä¸‹æ–°å»ºä¸¤ä¸ªå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°ç”¨äºä¹°å°è¯´ï¼Œç¬¬äºŒä¸ªå‡½æ•°ç”¨äºå›è°ƒä¹°å°è¯´çš„ç»“æœ`response`ã€‚

```c++
/*ä¹°å°è¯´å‡½æ•°*/
    void buy_novel()
    {
        RCLCPP_INFO(this->get_logger(), "ä¹°å°è¯´å»å–½");
        
    }
    
    /*æ¥æ”¶å°è¯´-å›è°ƒå‡½æ•°*/
    void novels_callback(rclcpp::Client<village_interfaces::srv::SellNovel>::SharedFuture  response)
    {
    
    }
```

å®Œæ•´ä»£ç ï¼š

```c++
#include "rclcpp/rclcpp.hpp"
#include "village_interfaces/srv/sell_novel.hpp"

// æå‰å£°æ˜çš„å ä½ç¬¦ï¼Œç•™ç€åˆ›å»ºå®¢æˆ·ç«¯çš„æ—¶å€™ç”¨
using std::placeholders::_1;

/*
    åˆ›å»ºä¸€ä¸ªç±»èŠ‚ç‚¹ï¼Œåå­—å«åšPoorManNode,ç»§æ‰¿è‡ªNode.
*/
class PoorManNode : public rclcpp::Node
{

public:
    /* æ„é€ å‡½æ•° */
    PoorManNode() : Node("zhang3")
    {
        // æ‰“å°ä¸€å¥è‡ªæˆ‘ä»‹ç»
        RCLCPP_INFO(this->get_logger(), "å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¾—äº†ç©·ç—…çš„å¼ ä¸‰.");
    }
    
    /*ä¹°å°è¯´å‡½æ•°*/
    void buy_novel()
    {
        RCLCPP_INFO(this->get_logger(), "ä¹°å°è¯´å»å–½");
        
    }
    
    /*æ¥æ”¶å°è¯´-å›è°ƒå‡½æ•°*/
    void novels_callback(rclcpp::Client<village_interfaces::srv::SellNovel>::SharedFuture  response)
    {
    
    }
private:
    // åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯
    rclcpp::Client<village_interfaces::srv::SellNovel>::SharedPtr client_;
};

/*ä¸»å‡½æ•°*/
int main(int argc, char **argv)
{
    rclcpp::init(argc, argv);
    /*äº§ç”Ÿä¸€ä¸ªPoorManNodeçš„èŠ‚ç‚¹*/
    auto node = std::make_shared<PoorManNode>();
    rclcpp::spin(node);
    rclcpp::shutdown();
    return 0;
}
```

### [3.4 å®ä¾‹åŒ–å®¢æˆ·ç«¯ã€ç¼–å†™è¯·æ±‚å‡½æ•°å’Œå›è°ƒå‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_34-å®ä¾‹åŒ–å®¢æˆ·ç«¯ã€ç¼–å†™è¯·æ±‚å‡½æ•°å’Œå›è°ƒå‡½æ•°)

#### [3.4.1 å®ä¾‹åŒ–å®¢æˆ·ç«¯](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_341-å®ä¾‹åŒ–å®¢æˆ·ç«¯)

è¿™ä¸ªæˆ‘ä»¬å¾ˆç†Ÿæ‚‰äº†ï¼Œå…ˆå£°æ˜å†å®ä¾‹åŒ–ï¼Œåœ¨æ„é€ å‡½æ•°é‡ŒåŠ ä¸€å¥è¯ã€‚

```
//å®ä¾‹åŒ–å®¢æˆ·ç«¯
client_ = this->create_client<village_interfaces::srv::SellNovel>("sell_novel");
```

å®ä¾‹åŒ–è°ƒç”¨è‡ªèº«çš„`create_client`å‡½æ•°å³å¯ï¼Œè¿™ä¸ªå‡½æ•°ä¾ç„¶æ˜¯ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ã€‚

è¿™é‡Œå®ä¾‹åŒ–çš„æ—¶å€™ä¹Ÿè¦æŒ‡æ˜å®¢æˆ·ç«¯çš„æ¥å£ç±»å‹ï¼ŒåŒæ—¶æŒ‡å®šè¦è¯·æ±‚çš„æœåŠ¡çš„åç§°`sell_novel`.

#### [3.4.2 ç¼–å†™è¯·æ±‚å‡½æ•°`buy_novel`](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_342-ç¼–å†™è¯·æ±‚å‡½æ•°buy_novel)

ç¼–å†™è¯·æ±‚å‡½æ•°`but_novel()`ã€‚

æ•´ä¸ªå‡½æ•°å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š

- ç­‰å¾…æœåŠ¡ç«¯ä¸Šçº¿
- æ„é€ è¯·æ±‚æ•°æ®
- å‘é€å¼‚æ­¥è¯·æ±‚

```
    void buy_novel()
    {
        RCLCPP_INFO(this->get_logger(), "ä¹°å°è¯´å»å–½");
        
        //1.ç­‰å¾…æœåŠ¡ç«¯ä¸Šçº¿
        while (!client_->wait_for_service(std::chrono::seconds(1)))
        {
            //ç­‰å¾…æ—¶æ£€æµ‹rclcppçš„çŠ¶æ€
            if (!rclcpp::ok())
            {
                RCLCPP_ERROR(this->get_logger(), "ç­‰å¾…æœåŠ¡çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­...");
                return;
            }
            RCLCPP_INFO(this->get_logger(), "ç­‰å¾…æœåŠ¡ç«¯ä¸Šçº¿ä¸­");
        }
        
        //2.æ„é€ è¯·æ±‚çš„é’±
        auto request = std::make_shared<village_interfaces::srv::SellNovel_Request>();
        //å…ˆæ¥äº”å—é’±çš„çœ‹çœ‹å¥½ä¸å¥½çœ‹
        request->money = 5; 
        
        //3.å‘é€å¼‚æ­¥è¯·æ±‚ï¼Œç„¶åç­‰å¾…è¿”å›ï¼Œè¿”å›æ—¶è°ƒç”¨å›è°ƒå‡½æ•°
        client_->async_send_request(request,std::bind(&PoorManNode::novels_callback, this, _1));
    };
```

ç»“æ„è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œç­‰å¾…æœåŠ¡ç«¯ä¸Šçº¿çš„æ—¶å€™æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯`client_->wait_for_service`è¿™ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°æ˜¯è¶…æ—¶æ—¶é—´ï¼Œå°é±¼è¿™é‡Œè®¾ç½®æˆ1sï¼Œå¦‚æœæœåŠ¡ç«¯æ²¡æœ‰ä¸Šçº¿åˆ™ä¸€ç›´ç­‰å¾…ã€‚

ç¬¬äºŒéƒ¨åˆ†æ„é€ è¯·æ±‚çš„é’±ï¼ŒC++è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„é•¿ï¼Œè¿™é‡Œä½¿ç”¨make_sharedåˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘`village_interfaces::srv::SellNovel_Request`çš„æŒ‡é’ˆï¼Œå¹¶èµ‹å€¼ç»™äº†requetã€‚å¯ä»¥ç†è§£ä¸ºåˆ›å»ºäº†ä¸€ä¸ªé’±è¢‹ã€‚

```
 auto request = std::make_shared<village_interfaces::srv::SellNovel_Request>();
```

åˆ›å»ºå¥½é’±è¢‹ï¼ˆrequestï¼‰ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹å¾€é’±è¢‹é‡Œè£…é’±ï¼Œè¿™é‡Œè£…äº†5å—é’±ã€‚

```
//å…ˆæ¥äº”å—é’±çš„çœ‹çœ‹å¥½ä¸å¥½çœ‹
request->money = 5; 
```

ç¬¬ä¸‰æ­¥å‘é€è¯·æ±‚

è¿™ä¸€æ­¥æˆ‘ä»¬å’ŒPythonä¸­ä¸€æ ·ï¼Œå‘é€çš„æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå¹¶ä¸”è®¾ç½®äº†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæ„æ€æ˜¯å½“æˆ‘ä»¬è¯·æ±‚ï¼ˆä¹°ä¹¦ï¼‰æˆåŠŸæ—¶ï¼Œè¯·è°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼ŒæŠŠç»“æœé€šè¿‡å›è°ƒå‡½æ•°çš„å‚æ•°ä¼ é€’è¿‡æ¥ã€‚

> å…³äºå›è°ƒå‡½æ•°å‰é¢æè¿‡å¥½å‡ æ¬¡äº†ï¼Œå°é±¼ä¹Ÿåœ¨å…¬ä¼—å·ä¸Šå†™äº†ç›¸å…³çš„æ–‡ç« ï¼Œä¸æ˜ç™½çš„åŒå­¦å¯ä»¥å‰å¾€ç¿»é˜…ã€‚

#### [3.4.3 ç¼–å†™å›è°ƒå‡½æ•°å¤„ç†ç»“æœ](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_343-ç¼–å†™å›è°ƒå‡½æ•°å¤„ç†ç»“æœ)

æ¥ç€ç¼–å†™å›è°ƒå‡½æ•°`novels_callback`å¤„ç†ç»“æœï¼Œå®Œæ•´çš„å›è°ƒå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼Œä¹Ÿå¾ˆç®€å•ï¼Œè·å–ç»“æœç„¶åéå†ç»“æœæ‰“å°ã€‚

> æ³¨æ„å‡½æ•°çš„å‚æ•°å¹¶ä¸æ˜¯`SellNovel`çš„`Response`å¯¹è±¡ï¼Œè€Œæ˜¯`SharedFuture`ï¼Œè¿™ä¸ªå°é±¼ä¼šå†™ç¯‡æ–‡ç« è¯´ä¸€è¯´ã€‚è¿™é‡Œç›´æ¥ç”¨å°±è¡Œï¼Œä½¿ç”¨`response`çš„`get()`è·å–ã€‚

```
    //åˆ›å»ºæ¥æ”¶åˆ°å°è¯´çš„å›è°ƒå‡½æ•°
    void novels_callback(rclcpp::Client<village_interfaces::srv::SellNovel>::SharedFuture  response)
    {
        auto result = response.get();
        
        RCLCPP_INFO(this->get_logger(), "æ”¶åˆ°%dç« çš„å°è¯´ï¼Œç°åœ¨å¼€å§‹æŒ‰ç« èŠ‚å¼€è¯»", result->novels.size());
        
        for(std::string novel:result->novels)
        {
            //æ‰“å°å°è¯´ç« èŠ‚å†…å®¹
            RCLCPP_INFO(this->get_logger(), "%s", novel.c_str());
        }
        
        RCLCPP_INFO(this->get_logger(), "å°è¯´è¯»å®Œäº†ï¼Œå¥½åˆºæ¿€ï¼Œå†™çš„çœŸä¸é”™ï¼Œå¥½æœŸå¾…ä¸‹é¢çš„ç« èŠ‚å‘€ï¼");
    }
```

#### [3.4.4 ä¿®æ”¹mainå‡½æ•°è°ƒç”¨è¯·æ±‚å‡½æ•°](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_344-ä¿®æ”¹mainå‡½æ•°è°ƒç”¨è¯·æ±‚å‡½æ•°)

å®Œæˆä¸Šé¢çš„å·¥ä½œä¹‹åè¿˜éœ€è¦ä¿®æ”¹ä¸€ä¸‹mainå‡½æ•°æ¥è°ƒç”¨ä¸€ä¸‹æˆ‘ä»¬çš„ä¹°å°è¯´å‡½æ•°ã€‚

```
int main(int argc, char **argv)
{
    rclcpp::init(argc, argv);
    /*äº§ç”Ÿä¸€ä¸ªZhang3çš„èŠ‚ç‚¹*/
    auto node = std::make_shared<PoorManNode>();
    node->buy_novel();
    /* è¿è¡ŒèŠ‚ç‚¹ï¼Œå¹¶æ£€æµ‹rclcppçŠ¶æ€*/
    rclcpp::spin(node);
    rclcpp::shutdown();
    return 0;
}
```

å®Œæˆä»£ç å‚è€ƒï¼š[ros2_town/wang2.cpp Â· fishros](https://github.com/fishros/ros2_town/blob/af8b29f7b23153d35348ebfcd3b1bc5760c6c5a6/village_wang/src/wang2.cpp)

### [3.5 ä¿®æ”¹CmkeLists.txtå¹¶ç¼–è¯‘](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_35-ä¿®æ”¹cmkeliststxtå¹¶ç¼–è¯‘)

#### [3.5.1 æ·»åŠ æŒ‡ä»¤](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_351-æ·»åŠ æŒ‡ä»¤)

å¼ ä¸‰èŠ‚ç‚¹ä¹‹å‰æ²¡æœ‰å®‰è£…è¿‡ï¼Œè¿™é‡Œéœ€è¦åœ¨`CMakeLists.txt`åŠ å…¥ä¸€ä¸ªå®‰è£…æŒ‡ä»¤ï¼Œå°†ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®‰è£…åˆ°installç›®å½•ä¸‹ã€‚

```
install(TARGETS
  zhang3_node
  DESTINATION lib/${PROJECT_NAME}
)
```

#### [3.5.2 ç¼–è¯‘](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_352-ç¼–è¯‘)

```
colcon build --packages-select village_zhang
```

![image-20210901201248290](https://fishros.com/d2lros2foxy/chapt4/4.10æœåŠ¡å®ç°(C++)/imgs/image-20210901201248290.png)

## [4.æµ‹è¯•](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_4æµ‹è¯•)

å®Œæˆäº†å¼ ä¸‰å’Œç‹äºŒçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ç¨‹åºåï¼Œæˆ‘ä»¬å°±å¯ä»¥æµ‹è¯•å•¦ã€‚

### [4.1è¿è¡Œå¼ ä¸‰](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_41è¿è¡Œå¼ ä¸‰)

æ‰“å¼€æ–°ç»ˆç«¯ï¼Œå…ˆsourceå†è¿è¡Œå¼ ä¸‰

```
source install/setup.bash
ros2 run village_zhang zhang3_node
```

### [4.2 è¿è¡Œç‹äºŒ](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_42-è¿è¡Œç‹äºŒ)

åˆ‡åˆ†ç»ˆç«¯ï¼Œsourceå¹¶è¿è¡Œç‹äºŒ

```
source install/setup.bash
ros2 run village_wang wang2_node 
```

### [4.3 è¿è¡Œæå››å†™ä¹¦](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_43-è¿è¡Œæå››å†™ä¹¦)

åˆ‡åˆ†ç»ˆç«¯ï¼Œsourceå¹¶è¿è¡Œæå››

```
source install/setup.bash
ros2 run village_li li4_node
```

### [4.5 ç»“æœå±•ç¤º](https://fishros.com/d2lros2foxy/#/chapt4/4.10æœåŠ¡å®ç°(C++)?id=_45-ç»“æœå±•ç¤º)

![image-20210901201805844](https://fishros.com/d2lros2foxy/chapt4/4.10æœåŠ¡å®ç°(C++)/imgs/image-20210901201805844.png)